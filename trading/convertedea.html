<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
	<link rel="stylesheet" type="text/css" media="screen" href="../codestyles.css">
	<link rel="icon" type="image/x-icon" href="./images/metatrader.png">
    <title>Converted Expert Advisor</title>
	<style>
@media screen 	
		{.container				{display: grid; grid-template-areas: "description description description description description description" "origin origin uploaded status status supplemental" "code code code code code code";}} 								
	</style>
    <script src="https://cdn.jsdelivr.net/npm/brython@3.9.5/brython.min.js"></script>
</head>
<body onload="brython()" class="codepage">
	<header>
		<div><a href="../index.html#trading"><img src="./images/back.png" alt="Back Arrow" title="Back Arrow"></a></div>
		<div><h1>Converted Expert Advisor</h1></div>
	</header>
	<main class="container">
		<div class="description"><p><strong>Description:</strong> This was a fascinating exercise in self-study. 
		I wanted to find a template from which I could write an Expert Advisor and modify to practice trades with. 
		The problem was I didn't know where to start, but luckily, I found the original code for this EA shared online by another trader. 
		It was an excellent starting point, with one major downside. It was written in MQL4 (for MetaTrader 4) and I was using MetaTrader 5, which uses MQL5. 
		The two languages are somewhat similar in that they are both based on C++, but not compatible. And I was completely new to both of them.
		What followed was a week-long nose dive into forums and technical documentation in order to convert a 1700+ line program (that I did not write) into another.
		The joy I felt the first time I ran the compiler without errors cannot be understated. 
		While this did not prove to be the success I was hoping for, it was an incredible lesson in understating how compiled languages work, 
		and that with enough tenacity, you can find what you're looking for.
		</p></div>
		<div class="origin"><p><strong>Original Creation:</strong> 31st Aug 2023</p></div>
		<div class="uploaded"><p><strong>Uploaded:</strong> 14th Jun 2025</p></div>
		<div class="status"><p><strong>Status:</strong> Code was written in MQL4 by another user, converted to MQL5 by me.</p></div>
		<div class="supplemental"><p><strong>Supplemental:</strong> N/A </p></div>
	<div class="gallery">
	</div>	
	<div class="code">		
		<!-- <button onclick="Toggle()">Toggle Original Python Code Display</button> -->
		<button onclick="Copy()">Copy the MQl5 Code</button>
	
	<p id="pycode">
//Can disable martingale feature by setting multiplier to 1<br>//Note: written in MQ4<br>#property strict //makes debugging easier - certain attributes will throw up errors when compiling if not properly implemented<br>//#include <externs.mqh><br>#include <Trade/Trade.mqh><br>#define NO_ERROR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  1 //define allows you to create your own identifier and give it an expression, which will be used in future instances<br>#define AT_LEAST_ONE_FAILED   2<br><br>enum ModeStops //create a list of identifiers for a limited data type<br>  {<br>   a = 1, //Stop all orders of this direction<br>   s = 2, //Carry on the basket till it will be closed<br>   n = 3, //Do not open new cranks anymore<br>  };<br>  <br>enum ModeClose<br>  {<br>   cldir  = 1, //Close orders of one direction<br>   all&nbsp;&nbsp;&nbsp;&nbsp;= 2, //Close all orders<br>  }; <br>  <br>enum Corner<br>  {<br>   left  = 0, //Left side<br>   right = 1, //Right side<br>  };<br><br>CTrade Trader;<br>//+------------------------------------------------------------------+<br>//|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  |<br>//+------------------------------------------------------------------+<br><br>input group "Take Profit Settings" <br>input int&nbsp;&nbsp;&nbsp;&nbsp;MaintakeprofitIpt&nbsp;&nbsp;&nbsp;&nbsp;   = 20;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   //Take Profit Value for Orders/Grid in Pips<br>input bool   UseaverageprofitIpt&nbsp;&nbsp;&nbsp;&nbsp; = true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Use Average Take Profit. If false, ignore values below.<br>input bool   UsedynamictakeprofitIpt = true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Use Dynamic Take Profit<br>input int&nbsp;&nbsp;&nbsp;&nbsp;StepdynamicTPIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Which Crank Starts Dynamic Take Profit<br>input double K_TPDecreaseIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Take Profit Multiplier<br>input int&nbsp;&nbsp;&nbsp;&nbsp;MinTakeProfitIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Minimum Take Profit Value&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <br>input bool   BreakevencloseIpt&nbsp;&nbsp;&nbsp;&nbsp;   = true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Breakeven Take Profit Value<br>input int&nbsp;&nbsp;&nbsp;&nbsp;StepforBEIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 4;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   //Which Crank Starts to Use Breakeven Rule<br><br>input group "Step Settings"<br>input double FirstStepIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 40;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   //First Step in Pips<br>input bool   StepfromvolatilityIpt   = false;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Calculate First Step by Volatility<br>input int&nbsp;&nbsp;&nbsp;&nbsp;PeriodVolatility_1Ipt   = 3;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   //Amount of Days for Volatility Calculation<br>input double K_StepvolIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Multiplier for the First Step <br>input bool   DynamicstepIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  = true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Use Dynamic Grid Step<br>input int&nbsp;&nbsp;&nbsp;&nbsp;StepincreasestepIpt&nbsp;&nbsp;&nbsp;&nbsp; = 1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Which crank starts dynamic step<br>input double K_StepincreaseIpt&nbsp;&nbsp;&nbsp;&nbsp;   = 2;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Step Multiplier<br>input int&nbsp;&nbsp;&nbsp;&nbsp;MaxcountstepsbuyIpt&nbsp;&nbsp;&nbsp;&nbsp; = 7;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   //Maximum Amount of Cranks in the Buy Basket<br>input int&nbsp;&nbsp;&nbsp;&nbsp;MaxcountstepsellIpt&nbsp;&nbsp;&nbsp;&nbsp; = 7;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   //Maximum Amount of Cranks in the Sell Basket<br>input int&nbsp;&nbsp;&nbsp;&nbsp;Tick_MemoryIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  = 25;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Maximum Amount of Ticks Cached<br>input double DeviationIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 1.8;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Deviation<br>input bool   NeutralizerIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  = true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Neutralizer<br>input double Pips_ThresholdIpt&nbsp;&nbsp;&nbsp;&nbsp;   = 500.0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Pips Threshold<br>input double Aux_ThresholdIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 300.0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Aux Threshold<br>input double StopLossFixedIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 0.03;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Stop Loss Amount<br><br>input group "Orders Volume"<br>input bool   Money_ManagementIpt&nbsp;&nbsp;&nbsp;&nbsp; = true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Money Management<br>input double Margin_PercentIpt&nbsp;&nbsp;&nbsp;&nbsp;   = 0.35;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Margin Percent<br>input double Lot_SizeIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 0.01;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Lots Amount for First Order in Grid<br>input double MultiplierIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   = 1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Volume Multiplier. 1 = Martingale Disabled.<br>input int&nbsp;&nbsp;&nbsp;&nbsp;MultipusestepIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 2;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Which Crank Starts to Apply Volume Multiplier<br>input double CommMultIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 4;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Commission Multiplier (used with volume)<br><br>input group "First Order"<br>input bool   CCIFiltreIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Use CCI Indicator for entry<br>input int&nbsp;&nbsp;&nbsp;&nbsp;Period_CCIIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   = 7;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   //CCI Period for Current Chart<br>input bool   UseADXIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   = false;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Use ADX for entries<br><br>input group "Manual Intervention"<br>input bool   AllowbuyIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Permission for Buy Orders<br>input bool   AllowsellIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Permission for Sell Orders<br>ModeStops Stopmode_2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = s;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Variant of Orders Stops<br>input bool   StopTradesLevelIpt&nbsp;&nbsp;&nbsp;&nbsp;  = false;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Stop Trading After Crossing Critical Level<br>ModeStops Stopmode_3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = a;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Variant of Order Stops After Crossing Critical Levels<br>input double BuyStopLevelIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Critical Levels for Buy Orders Stop<br>input double SellStopLevelIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Critical Levels for Sell Orders Stop<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //parameters below do not impact on the first order in the basket<br>input double ManualstepBuyIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Forced Basket Step Size for Buy Orders<br>input double ManuallotBuyIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Forced Orders Lot for the Next Buy Orders<br>input double ManualstepSellIpt&nbsp;&nbsp;&nbsp;&nbsp;   = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Forced Basket Step Size for Sell Orders<br>input double ManuallotSellIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Forced Orders Lot for the Next Sell Orders<br><br>input group "Increment of Volatility"<br>input bool   UsefiltrevolatIpt&nbsp;&nbsp;&nbsp;&nbsp;   = true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Use Volatility Filter <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //originally turned on<br>input int&nbsp;&nbsp;&nbsp;&nbsp;Periodvolatility_2Ipt   = 20;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   //Period for Volatility Calculation<br>input double LineofvolatilityIpt&nbsp;&nbsp;&nbsp;&nbsp; = 1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Multiplier for Critical Volatility<br>ModeClose Stopmode_4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= all;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   //Variant for orders closing<br><br>input group "Additional Settings"<br>int&nbsp;&nbsp;&nbsp;&nbsp;Magic_Buy&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 8989;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Advisor Buy Magic number<br>int&nbsp;&nbsp;&nbsp;&nbsp;Magic_Sell&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 8990;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Advisor Sell Magic number<br>int&nbsp;&nbsp;&nbsp;&nbsp;Magic_Aux&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 8991;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Advisor Aux Magic number<br>sinput bool   ECNflagIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = false;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Flag for ECN accounts<br>input int&nbsp;&nbsp;&nbsp;&nbsp;SlippageIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 3;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Pips Slippage<br>input int&nbsp;&nbsp;&nbsp;&nbsp;RetryIpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 5;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Retry<br><br>input group "Info Panel Settings"<br>bool   Showinfopanel&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Show info-panel<br>Corner Side&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = right;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Info-panel location on the chart<br>color  Textcolor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= clrNavy;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   //Info-panel text color<br>color  Backgroundcolor&nbsp;&nbsp;&nbsp;&nbsp;  = clrGainsboro;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Info-panel background color<br>bool   Showcriticallevels   = true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //"Show the critical levels<br>color  Levelscolorbuy&nbsp;&nbsp;&nbsp;&nbsp;   = clrMediumBlue;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Critical level line color for buy orders<br>color  Levelscolorsell&nbsp;&nbsp;&nbsp;&nbsp;  = clrOrangeRed;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Critical level line color for sell orders<br><br>int MaxPos=MaxcountstepsbuyIpt;<br><br>datetime lastopentime;<br>double CCI_1, CCI_2, lastbuyprice, lastsellprice, step,nextlot, lastTP;<br>bool check, AlertMaxStepsBuy=false, AlertMaxStepsSell=false, AllowafterlevelBuy=true, AllowafterlevelSell=true, Flagsellinfo=false, Flagbuyinfo=false,<br>MarginAgreed=true, Popupmargininfobuy=false, Popupmargininfosell=false, Stoptrading=false, Allowbuylevel=true, Allowselllevel=true, Alertsellvolat=false, Alertbuyvolat=false;<br>long aticket, lastticket;<br><br>// Input data for info-panel //<br>string currency&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   = Symbol();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   //Currency pair<br>double depositpercent&nbsp;&nbsp;&nbsp;&nbsp; = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Percentage of the whole deposit<br>double depositvalue&nbsp;&nbsp;&nbsp;&nbsp;   = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Risk deposit<br>double depositloadpersent = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Current risk deposit load<br>double firstorderlot&nbsp;&nbsp;&nbsp;&nbsp;  = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Volume of the first orders.<br><br>string allowbuy&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   = "";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Buy orders are allowed<br>int&nbsp;&nbsp;&nbsp;&nbsp;currentstepbuy&nbsp;&nbsp;&nbsp;&nbsp; = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Current crank for buy basket<br>double sumlotbuy&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Total volume of buy orders, lots<br>int&nbsp;&nbsp;&nbsp;&nbsp;maxstepsbuy&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= MaxcountstepsbuyIpt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   //Accepted crank amount for buy orders<br>double buybasketprofit&nbsp;&nbsp;&nbsp;&nbsp;= 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Total profit of opened buy orders<br>double buystepvalue&nbsp;&nbsp;&nbsp;&nbsp;   = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Current grid step<br>double nextpricebuy&nbsp;&nbsp;&nbsp;&nbsp;   = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Next order open price<br>double nextlotbuy&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Volume of the next buy order<br><br>string allowsell&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  = "";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Sell orders are allowed<br>int&nbsp;&nbsp;&nbsp;&nbsp;currentstepsell&nbsp;&nbsp;&nbsp;&nbsp;= 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Current crank for sell basket<br>double sumlotsell&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Total volume of sell orders, lots<br>int&nbsp;&nbsp;&nbsp;&nbsp;maxstepssell&nbsp;&nbsp;&nbsp;&nbsp;   = MaxcountstepsellIpt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   //Accepted crank amount for sell orders<br>double sellbasketprofit   = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Total profit of opened sell orders<br>double sellstepvalue&nbsp;&nbsp;&nbsp;&nbsp;  = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Current grid step<br>double nextpricesell&nbsp;&nbsp;&nbsp;&nbsp;  = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Next order open price<br>double nextlotsell&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //Volume of the next sell order<br><br>//--<br><br>int Stability_Period=5;<br>int Period_1=3;<br>int Period_2=14;<br>uint err = 0; //added by GPM<br>ENUM_SYMBOL_INFO_DOUBLE pricetype;<br><br>int Maintakeprofit = MaintakeprofitIpt;<br>bool Useaverageprofit = UseaverageprofitIpt;<br>bool Usedynamictakeprofit = UsedynamictakeprofitIpt;<br>int StepdynamicTP = StepdynamicTPIpt;<br>double K_TPDecrease = K_TPDecreaseIpt;<br>int MinTakeProfit = MinTakeProfitIpt;<br>bool Breakevenclose = BreakevencloseIpt;<br>int StepforBE = StepforBEIpt;<br><br>double FirstStep = FirstStepIpt;<br>bool Stepfromvolatility = StepfromvolatilityIpt;<br>int PeriodVolatility_1 = PeriodVolatility_1Ipt;<br>double K_Stepvol = K_StepvolIpt;<br>bool Dynamicstep = DynamicstepIpt;<br>int Stepincreasestep = StepincreasestepIpt;<br>double K_Stepincrease = K_StepincreaseIpt;<br>int Maxcountstepsbuy = MaxcountstepsbuyIpt;<br>int Maxcountstepsell = MaxcountstepsellIpt;<br>int Tick_Memory = Tick_MemoryIpt;<br>double Deviation = DeviationIpt;<br>bool Neutralizer = NeutralizerIpt;<br>double Pips_Threshold = Pips_ThresholdIpt;<br>double Aux_Threshold = Aux_ThresholdIpt;<br><br>bool Money_Management = Money_ManagementIpt;<br>double Margin_Percent = Margin_PercentIpt;<br>double Lot_Size = Lot_SizeIpt;<br>double Multiplier = MultiplierIpt;<br>int Multipusestep = MultipusestepIpt;<br>double CommMult = CommMultIpt;<br><br>bool CCIFiltre = CCIFiltreIpt;<br>int Period_CCI = Period_CCIIpt;<br><br>bool Allowbuy = AllowbuyIpt;<br>bool Allowsell = AllowsellIpt;<br>bool StopTradesLevel = StopTradesLevelIpt;<br>double BuyStopLevel = BuyStopLevelIpt;<br>double SellStopLevel = SellStopLevelIpt;<br>double ManualstepBuy = ManualstepBuyIpt;<br>double ManuallotBuy = ManuallotBuyIpt;<br>double ManualstepSell = ManualstepSellIpt;<br>double ManuallotSell = ManuallotSellIpt;<br><br>bool Usefiltrevolat = UsefiltrevolatIpt;<br>int Periodvolatility_2 = Periodvolatility_2Ipt;<br>double Lineofvolatility = LineofvolatilityIpt;<br><br>bool ECNflag = ECNflagIpt;<br>int Slippage = SlippageIpt;<br>int Retry = RetryIpt;<br>double slfixed = StopLossFixedIpt;<br><br>//+------------------------------------------------------------------+<br>//| Expert initialization function&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   |<br>//+------------------------------------------------------------------+<br>int OnInit()<br>  {<br>  <br>  Trader.SetExpertMagicNumber(12345);<br>   if(Digits()==3 || Digits()==5) //used to determine price accuracy on current chart. 5 for most, 3 for USDJPY<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  Maintakeprofit *= 10; //multiply each of these by 10 (default 10)<br>&nbsp;&nbsp;&nbsp;&nbsp;  MinTakeProfit  *= 10; //default 1<br>&nbsp;&nbsp;&nbsp;&nbsp;  FirstStep&nbsp;&nbsp;&nbsp;&nbsp;  *= 10; //default 20<br>&nbsp;&nbsp;&nbsp;&nbsp;  Slippage&nbsp;&nbsp;&nbsp;&nbsp;   *= 10; //default 3<br>&nbsp;&nbsp;&nbsp;&nbsp;  ManualstepBuy  *= 10; //default 0<br>&nbsp;&nbsp;&nbsp;&nbsp;  ManualstepSell *= 10; //default 0<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   //error alerts if parameters don't make sense<br>   if(Maintakeprofit<=0)<br>&nbsp;&nbsp;&nbsp;&nbsp;  Alert("Wrong take-profit! It has to be more than zero!");<br>   if(FirstStep<=0 && (Stepfromvolatility==false || PeriodVolatility_1<=0 || K_Stepvol<=0)) //defaults false, 20, 0.5<br>&nbsp;&nbsp;&nbsp;&nbsp;  Alert("Wrong step parameters!!! All parameters for the first step have to be more than zero!");<br>   if(Usefiltrevolat==true && Periodvolatility_2<=0) //defaults true, 20<br>&nbsp;&nbsp;&nbsp;&nbsp;  Alert("Wrong parameters for exit with increment of volatility!! Multiplier has to be more than zero!");<br>   if(Lot_Size<=0) //default 0.01<br>&nbsp;&nbsp;&nbsp;&nbsp;  Alert("Wrong volume parameters!! Lot has to be more than zero!");<br>   if(CCIFiltre==true && Period_CCI<=1) //default true, 50<br>&nbsp;&nbsp;&nbsp;&nbsp;  Alert("Wrong period of CCI indicator!!!");<br>   if(Usedynamictakeprofit==true && (StepdynamicTP<=0 || K_TPDecrease<=0)) //defaults true, 3, 1<br>&nbsp;&nbsp;&nbsp;&nbsp;  Alert("Wrong parameters for dynamic take-profit!! Step and multiplier have to be more than zero!!");<br>   if(Multiplier<=0) //default true<br>&nbsp;&nbsp;&nbsp;&nbsp;  Alert("Wrong volume multiplier!! It has to be more than zero!");<br><br>   if(Showcriticallevels==true) //Draw critical levels<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if (BuyStopLevel>0) //default 0<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{//objectcreate(chart id, name, enum_object, window index, time of 1st anchor point, price of first anchor point, <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//timeN=0 time of nth anchor point, priceN=0 price of nth anchor point) equation below is for price of first anchor point<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ObjectCreate(0, "StopBuyLevel",OBJ_HLINE,0,0,NormalizeDouble(BuyStopLevel,Digits() ) );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetInteger(0, "StopBuyLevel",OBJPROP_COLOR,Levelscolorbuy);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetInteger(0, "StopBuyLevel",OBJPROP_STYLE,STYLE_DASHDOTDOT);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetInteger(0, "StopBuyLevel",OBJPROP_WIDTH,1);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetTextMQL4("StopBuyLevel","Critical level for BUY orders",8,"Calibri",clrBlack);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (SellStopLevel>0) //default 0<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ObjectCreate(0, "StopSellLevel",OBJ_HLINE,0,0,NormalizeDouble(SellStopLevel,Digits()));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetInteger(0, "StopSellLevel",OBJPROP_COLOR,Levelscolorsell);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetInteger(0, "StopSellLevel",OBJPROP_STYLE,STYLE_DASHDOTDOT);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetInteger(0, "StopSellLevel",OBJPROP_WIDTH,1);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetTextMQL4("StopSellLevel","Critical level for SELL orders",8,"Calibri",clrBlack);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>   if(Showinfopanel==true)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0, "Background",OBJ_LABEL,0,0,0);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Background","g",160,"Webdings",Backgroundcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0, "Background",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0, "Background",OBJPROP_XDISTANCE,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0, "Background",OBJPROP_YDISTANCE,20);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Background_2",OBJ_LABEL,0,0,0);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Background_2","g",160,"Webdings",Backgroundcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Background_2",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Background_2",OBJPROP_XDISTANCE,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Background_2",OBJPROP_YDISTANCE,315);<br>&nbsp;&nbsp;&nbsp;&nbsp;  <br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0, "Background_3",OBJ_LABEL,0,0,0);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Background_3","g",160,"Webdings",Backgroundcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Background_3",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Background_3",OBJPROP_XDISTANCE,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Background_3",OBJPROP_YDISTANCE,150);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0, "Info_1",OBJ_LABEL,0,0,0);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_1",currency+"   SyTurn",14,"Stencil",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_1",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_1",OBJPROP_XDISTANCE,15);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_1",OBJPROP_YDISTANCE,30);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0, "Info_2",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_2","________________",14,"Arial",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0, "Info_2",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0, "Info_2",OBJPROP_XDISTANCE,9);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_2",OBJPROP_YDISTANCE,32);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_3",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_3","Power:  ",10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_3",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_3",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_3",OBJPROP_YDISTANCE,60);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_4",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_4","Neutralizer BUY:  OFF",10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_4",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_4",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_4",OBJPROP_YDISTANCE,80);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_5",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_5","Neutralizer SELL:  OFF",10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_5",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_5",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_5",OBJPROP_YDISTANCE,100);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  firstorderlot=Findfirstordervolume();<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_6",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_6","First orders volume:  "+DoubleToString(firstorderlot,2),10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_6",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_6",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_6",OBJPROP_YDISTANCE,120);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_7",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_7","________________",14,"Arial",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_7",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_7",OBJPROP_XDISTANCE,9);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_7",OBJPROP_YDISTANCE,120);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_8",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_8","BUY BASKET PARAMETERS",8,"Arial Black",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_8",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_8",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_8",OBJPROP_YDISTANCE,150);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  if(Allowbuy==false) //default true, set by user<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; switch(Stopmode_2) //of the modestops data type, set to s (2) by default<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case a: allowbuy = "Buy orders are forbidden!"; break; //lower case allowbuy is an empty string by default<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case s: allowbuy = "New baskets are forbidden!"; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case n: allowbuy = "New crank is forbidden!"; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  else allowbuy="Buy orders are allowed!"; //first instance of this string appearing<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_9",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_9",allowbuy,10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_9",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_9",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_9",OBJPROP_YDISTANCE,170);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_10",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_10","Current crank: "+DoubleToString(currentstepbuy,0),10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_10",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_10",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_10",OBJPROP_YDISTANCE,190);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_11",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_11","Total volume, lots: "+DoubleToString(sumlotbuy,2),10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_11",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_11",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_11",OBJPROP_YDISTANCE,210);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0, "Info_12",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_12","Accepted cranks amount: "+IntegerToString(maxstepsbuy),10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_12",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_12",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_12",OBJPROP_YDISTANCE,230);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_13",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_13","Total profit of opened: "+DoubleToString(buybasketprofit,1),10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_13",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_13",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_13",OBJPROP_YDISTANCE,250);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_14",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_14","Current grid step: "+DoubleToString(buystepvalue,1)+"p.",10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_14",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_14",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_14",OBJPROP_YDISTANCE,270);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_15",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_15","Next order open price: "+DoubleToString(nextpricebuy,Digits()),10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_15",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_15",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_15",OBJPROP_YDISTANCE,290);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_16",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_16","Next order volume: "+DoubleToString(nextlotbuy,2),10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_16",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_16",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_16",OBJPROP_YDISTANCE,310);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_17",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_17","________________",14,"Arial",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_17",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_17",OBJPROP_XDISTANCE,9);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_17",OBJPROP_YDISTANCE,310);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_18",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_18","SELL BASKET PARAMETERS",8,"Arial Black",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_18",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_18",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_18",OBJPROP_YDISTANCE,340);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  if(Allowsell==false) //default true, set by user<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; switch(Stopmode_2)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case a: allowsell = "Sell orders are forbidden!"; break; //lower case allowsell is empty string by default<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case s: allowsell = "New baskets are forbidden!"; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case n: allowsell = "New crank is forbidden!"; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  else allowsell="Sell orders are allowed!"; //first instance of this string appearing<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_19",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_19",allowsell,10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_19",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_19",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_19",OBJPROP_YDISTANCE,360);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_20",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_20","Current crank: "+DoubleToString(currentstepsell,0),10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_20",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_20",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_20",OBJPROP_YDISTANCE,380);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_21",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_21","Total volume, lots: "+DoubleToString(sumlotsell,2),10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_21",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_21",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_21",OBJPROP_YDISTANCE,400);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_22",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_22","Accepted cranks amount: "+IntegerToString(maxstepssell),10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_22",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_22",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_22",OBJPROP_YDISTANCE,420);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_23",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_23","Total profit opened: "+DoubleToString(sellbasketprofit,1),10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_23",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_23",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_23",OBJPROP_YDISTANCE,440);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_24",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_24","Current grid step: "+DoubleToString(sellstepvalue,1)+"p.",10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_24",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_24",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_24",OBJPROP_YDISTANCE,460);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_25",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_25","Next order open price: "+DoubleToString(nextpricesell,Digits()),10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_25",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_25",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_25",OBJPROP_YDISTANCE,480);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectCreate(0,"Info_26",OBJ_LABEL,0,0,0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetTextMQL4("Info_26","Next order volume: "+DoubleToString(nextlotsell,2),10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_26",OBJPROP_CORNER,Side);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_26",OBJPROP_XDISTANCE,10);<br>&nbsp;&nbsp;&nbsp;&nbsp;  ObjectSetInteger(0,"Info_26",OBJPROP_YDISTANCE,500);<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>   return(INIT_SUCCEEDED); //end of on initialization<br>  }<br>//+------------------------------------------------------------------+<br>//| Expert deinitialization function&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br>//+------------------------------------------------------------------+<br>void OnDeinit(const int reason) //deletes all visual stuff when EA is removed<br>  {<br>  if (Showinfopanel==true)<br>  {<br>   ObjectDelete(0, "StopBuyLevel");<br>   ObjectDelete(0, "StopSellLevel");<br>   ObjectDelete(0, "Background");<br>   ObjectDelete(0, "Background_2");<br>   ObjectDelete(0, "Background_3");<br>   ObjectDelete(0, "Info_1");<br>   ObjectDelete(0, "Info_2");<br>   ObjectDelete(0, "Info_3");<br>   ObjectDelete(0, "Info_4");<br>   ObjectDelete(0, "Info_5");<br>   ObjectDelete(0, "Info_6");<br>   ObjectDelete(0, "Info_7");<br>   ObjectDelete(0, "Info_8");<br>   ObjectDelete(0, "Info_9");<br>   ObjectDelete(0, "Info_10");<br>   ObjectDelete(0, "Info_11");<br>   ObjectDelete(0, "Info_12");<br>   ObjectDelete(0, "Info_13");<br>   ObjectDelete(0, "Info_14");<br>   ObjectDelete(0, "Info_15");<br>   ObjectDelete(0, "Info_16");<br>   ObjectDelete(0, "Info_17");<br>   ObjectDelete(0, "Info_18");<br>   ObjectDelete(0, "Info_19");<br>   ObjectDelete(0, "Info_20");<br>   ObjectDelete(0, "Info_21");<br>   ObjectDelete(0, "Info_22");<br>   ObjectDelete(0, "Info_23");<br>   ObjectDelete(0, "Info_24");<br>   ObjectDelete(0, "Info_25");<br>   ObjectDelete(0, "Info_26");<br>   }<br>  }<br>//+------------------------------------------------------------------+<br>//| Expert tick function&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br>//+------------------------------------------------------------------+<br>void OnTick()<br>  {<br>int n=1;<br><br>if(_Digits==3 || _Digits==5)<br>  n=10;<br><br>//--<br><br>int p=0;<br>//static int Tick_Count=0, Ready=0; //static = value doesn't change after a function call???<br>//static double Current_Price=0;<br>//double Tick_Base[], Tick_Base_Temp[]; //Greyed out section as not needed?<br>//<br>//ArraySetAsSeries(Tick_Base, true);<br>//ArraySetAsSeries(Tick_Base_Temp, true);<br>//ArrayResize(Tick_Base, Tick_Memory); //tick memory 100 by default. Still not sure what array resize does exactly. limits array size?<br>//ArrayResize(Tick_Base_Temp, Tick_Memory);<br><br>MqlTick last_tick;<br>SymbolInfoTick(_Symbol,last_tick);<br>double Bid=last_tick.bid;<br>double Ask=last_tick.ask;<br><br>//Greyed out section as not needed? Tick Base not needed for iBands<br>//if(Current_Price!=Bid) //should bid be symbol_bid? hasn't been defined yet. If current price is not equal to the bid, fill arrays and set current price to bid<br>//  {<br>//  Tick_Count++; //increases tick count by 1<br>//  if(Tick_Count>Tick_Memory-1) //if tick count is higher than tick memory, reset tick count<br>//&nbsp;&nbsp;&nbsp;&nbsp;{<br>//&nbsp;&nbsp;&nbsp;&nbsp;Tick_Count=0;<br>//&nbsp;&nbsp;&nbsp;&nbsp;Ready=1;<br>//&nbsp;&nbsp;&nbsp;&nbsp;}<br>//  for(p=Tick_Memory-1; p>=0; p--)<br>//&nbsp;&nbsp;&nbsp;&nbsp;{<br>//&nbsp;&nbsp;&nbsp;&nbsp;Tick_Base_Temp[p]=Tick_Base[p]; //for each value of p (using tick memory), set the pth element of first array to the pth value of the second array<br>//&nbsp;&nbsp;&nbsp;&nbsp;}<br>//  for(p=Tick_Memory-1; p>=1; p--)<br>//&nbsp;&nbsp;&nbsp;&nbsp;{<br>//&nbsp;&nbsp;&nbsp;&nbsp;Tick_Base[p]=Tick_Base_Temp[p-1]; //for each value of p, sets the pth value of the first array to the pth + 1 value of the second array<br>//&nbsp;&nbsp;&nbsp;&nbsp;}<br>//  Tick_Base[0]=Bid; //sets the first element of the array to the current bid price<br>//  Current_Price=Bid; //sets the current price variable to bid price<br>//  }<br><br>//double BB_Upper_Tick=0; //BB = bollinger band<br>//double BB_Lower_Tick=0;<br>//<br>////1 = upper band, 2 = lower band<br>//<br>//BB_Upper_Tick=NormalizeDouble(BBands(1), _Digits); //function for Bollinger bands. MT5 equivalents is ibands()<br>//BB_Lower_Tick=NormalizeDouble(BBands(2), _Digits); // Deviation is 1.5 by default<br>//<br>//static int Trigger_BB=0;<br>//int BB_Signal=0;<br>//double iclosevalue2 = iClose(Symbol(),Period(),2);<br>//double iclosevalue1 = iClose(Symbol(),Period(),1);<br>//<br>//if(iclosevalue2>BB_Upper_Tick){ //iclose: returns close price of bar<br>//  Trigger_BB=1;}<br>//  <br>//if(iclosevalue2<BB_Lower_Tick) //sets trigger to positive or negative depending on whether close price is inside or outside of Bollinger Band<br>//  Trigger_BB=-1;<br>//// In order to trigger, a candle two candles ago must close outside of the current BB range. And the next candle must close in the current BB range.<br>//if(Trigger_BB!=0 && iclosevalue1>BB_Lower_Tick && iclosevalue1<BB_Upper_Tick) //sets signal, resets trigger<br>//  {<br>//  if(Trigger_BB>0)<br>//&nbsp;&nbsp;&nbsp;&nbsp;BB_Signal=-1;<br>//  if(Trigger_BB<0)<br>//&nbsp;&nbsp;&nbsp;&nbsp;BB_Signal=1;<br>//  Trigger_BB=0;<br>//  }<br><br>//--<br><br>int Sell_Signal=0, Buy_Signal=0;<br>int ADX_Norm=0;<br><br>//-- Moving Averages<br><br>double ADX_TF1 = ADXcheck(_Period, 14, 0);<br>double ADX_TF2 = ADXcheck(PERIOD_M5, 14, 0);<br>double ADX_TF3 = ADXcheck(PERIOD_M15, 14, 0);<br><br>int Multiplicator=0;<br><br>//-- ADX + Multiplicator<br><br>double ADX_Norm_TF1=ADXcheck(PERIOD_D1, 18, 1); //calculating ADX over an 18 period on the daily timeframe, using close price, starting 1 period ago<br><br>if(ADX_Norm_TF1<=30) //sets multiplicator based on how high current ADX is<br>  Multiplicator=2;<br><br>if(ADX_Norm_TF1>30 && ADX_Norm_TF1<60)<br>  Multiplicator=3;  <br><br>if(ADX_Norm_TF1>=60)<br>  Multiplicator=1;<br><br>//-- Moving Averages<br><br>double MA_High_P1 = MAcheck(Period_1, Multiplicator, MODE_EMA, PRICE_HIGH, 1);<br>double MA_Low_P1 = MAcheck(Period_1, Multiplicator, MODE_EMA, PRICE_LOW, 1);<br>double MA_High_P2 = MAcheck(Period_2, Multiplicator, MODE_EMA, PRICE_HIGH, 1);<br>double MA_Low_P2 = MAcheck(Period_2, Multiplicator, MODE_EMA, PRICE_LOW, 1);<br> //uses short periods if ADX is very high, longer periods if ADX is low, even longer periods if ADX is trending<br><br>//-- SAR<br>//author wrote out multiple calculations instead of using an array<br>double SAR_T1=SARcheck(1); //isar = parabolic stop and reverse system. used for determining trend and for setting SL. if above price, downtrend, if below price, uptrend<br>double SAR_T2=SARcheck(2); //symbol, period, step (acceleration factor), max value of step, shift<br>double SAR_T3=SARcheck(3); //step and max value of step are at their defaults<br><br>MqlRates bar[];<br>ArraySetAsSeries(bar, true);<br>CopyRates(_Symbol, PERIOD_CURRENT, 0, 5, bar);<br><br>int SAR=0;<br>//determining trend. if SAR for the last 3 bars is higher than the high price, in a downtrend. Vice versa: uptrend<br>if(SAR_T1>bar[1].high && SAR_T2>bar[2].high && SAR_T3>bar[3].high) //high and low are probably bar[1].high, etc<br>  SAR=-1;<br>if(SAR_T1<bar[1].low && SAR_T2<bar[2].low && SAR_T3<bar[3].low)<br>  SAR=1;<br><br>//-- MACD<br><br>double MACD_Main_H=MACDcheck(PRICE_OPEN, 0); //symbol, period, fast ema, slow ema, signal line averaging period(?), applied price, indicator line (main vs signal), shift<br>double MACD_Signal_H=MACDcheck(PRICE_OPEN, 1);<br><br>double MACD_Main_L=MACDcheck(PRICE_CLOSE, 0);<br>double MACD_Signal_L=MACDcheck(PRICE_CLOSE, 1);<br><br>int MACD=0;<br>//determining trend from MACD<br>if(MACD_Main_H>MACD_Signal_H && MACD_Main_L>MACD_Signal_L)<br>  MACD=1;<br>  <br>if(MACD_Main_H<MACD_Signal_H && MACD_Main_L<MACD_Signal_L)<br>  MACD=-1;<br><br>//-- EMA<br><br>double EMA_5=MAcheck(50, 1, MODE_EMA, PRICE_CLOSE, 0); //symbol, period, averaging period, MA shift, averaging method (EMA), applied price, shift<br>double EMA_10=MAcheck(200, 1, MODE_EMA, PRICE_CLOSE, 0);<br><br>int EMA=0;<br>//determining trend using EMA positions<br>if(EMA_5>EMA_10)<br>  EMA=1;<br>if(EMA_5<EMA_10)<br>  EMA=-1;<br><br>//-- Triggering Decision<br><br>ADX_Norm=1;<br><br>if (UseADXIpt == true){<br>   if(ADX_TF1>40 && ADX_TF2<40 && ADX_TF3<40){ //trending on 1M but not on 5M or 15M<br>&nbsp;&nbsp;&nbsp;&nbsp;  ADX_Norm = 1;}<br>   else{<br>&nbsp;&nbsp;&nbsp;&nbsp;  ADX_Norm = 0;}}<br><br>//is the low of the previous bar less than the longer MA that uses lows?<br>if(EMA==-1 && MACD==-1 && SAR==-1 && iLow(Symbol(),Period(),1)<MA_Low_P2 && ADX_Norm == 1)// && BB_Signal==-1) //ilow/ihigh gives low/price price for (here) 1 bar ago<br>  Buy_Signal=1;<br>//is the high of the previous bar greater than the shorter MA that uses highs?<br>if(EMA==1 && MACD==1 && SAR==1 && iHigh(Symbol(),Period(),1)>MA_High_P1 && ADX_Norm == 1){// && BB_Signal==1){<br>//  Print("Iclosevalue2: " + string(iclosevalue2) + " / Iclosevalue 1: " + string(iclosevalue1) + " / BBUpperTick: " +  string(BB_Upper_Tick) + " / BBLowerTick: " + string(BB_Lower_Tick));<br>  Sell_Signal=1;}<br><br>//-- Managing number of positions?<br><br>int Pos_Open=0, h=0;<br>int Sell_Position=0, Buy_Position=0, Aux_Position=0, Sell_Loser=0, Buy_Loser=0, Sell_Winner=0, Buy_Winner=0, Aux_Direction=0;<br>int a=-1, b=-1, c=0;<br>static int Neutralize=0;<br>static int Repopulate=0;<br>static int Counting=0;<br>double Profit_Buy=0, Profit_Sell=0, Profit_Temp=0, Profit_Aux=0, Aux_Lots_Cached=0;<br>double Buy_Loss=0, Sell_Loss=0, Buy_Profit=0, Sell_Profit=0, Aux_Profit=0;<br>double Buy_Open_Price_Cached=0, Sell_Open_Price_Cached=10000;<br>double Buy_Loss_Array[][2], Buy_Profit_Array[][2], Sell_Loss_Array[][2], Sell_Profit_Array[][2], Aux_Array[][2], Aux_Array_Target[][2];<br>//defining 2D arrays, limiting the y(?) dimension to a size of 2<br>if(ArraySize(Buy_Loss_Array)!=MaxPos*4) // Maxpos is Maxcountstepsbuy by default, which is 10 by default, which is "number of cranks"<br>  ArrayResize(Buy_Loss_Array,MaxPos*4); //if the size of the array is not maxpos*4, sets the array to this size<br>if(ArraySize(Buy_Profit_Array)!=MaxPos*4) //does this limit the x (?) dimension to 20? NO!<br>  ArrayResize(Buy_Profit_Array,MaxPos*4); //Array Resize resizes the FIRST dimension. So there should be 40 elements in the x dimension.<br>if(ArraySize(Sell_Loss_Array)!=MaxPos*4)<br>  ArrayResize(Sell_Loss_Array,MaxPos*4);<br>if(ArraySize(Sell_Profit_Array)!=MaxPos*4)<br>  ArrayResize(Sell_Profit_Array,MaxPos*4);<br>if(ArraySize(Aux_Array)!=MaxPos*4)<br>  ArrayResize(Aux_Array,MaxPos*4);<br>if(ArraySize(Aux_Array_Target)!=MaxPos*4)<br>  ArrayResize(Aux_Array_Target,MaxPos*4);<br>//we're still in On Tick<br><br><br>//Profit Temp calculations<br><br>for(h=PositionsTotal()-1;h>=0;h--) //do this for all orders (technically not specified as active until next line) modifying profit counters for buy/sell<br>  {<br>&nbsp;&nbsp;&nbsp;&nbsp;if(PositionGetTicket(h)>0) //returns true if position is found. selects the index of an order in the order pool, mode = trades means active trades<br>&nbsp;&nbsp;&nbsp;&nbsp;  {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   if(PositionGetInteger(POSITION_MAGIC)==Magic_Sell)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {  <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Pos_Open++; //set as zero a few lines ago. increases by 1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Sell_Position++; //ditto<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Profit_Temp = PositionGetDouble(POSITION_PROFIT) + PositionGetDouble(POSITION_VOLUME)*CommMult + PositionGetDouble(POSITION_SWAP); //profit temp set as 0 initially. now set to current trade profit + current trade commission + rollover amount<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   if(Profit_Temp<0) //if trade is at net negative<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Sell_Loser++; //increase this variable by 1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Sell_Loss += Profit_Temp; //add this (lack of) profit to sell loss<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   if(Profit_Temp>=0) // if trade is at net positive<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Sell_Winner++;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Sell_Profit += Profit_Temp;  //increase these variables<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Profit_Sell += Profit_Temp; //regardless, add the amount this trade has made (or lost) to the profit sell variable<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   } <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   if(PositionGetInteger(POSITION_MAGIC)==Magic_Buy) //same as above but for buy trades<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   { <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Pos_Open++;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Buy_Position++;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Profit_Temp = PositionGetDouble(POSITION_PROFIT) + PositionGetDouble(POSITION_VOLUME)*CommMult + PositionGetDouble(POSITION_SWAP);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   if(Profit_Temp<0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Buy_Loser++;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Buy_Loss += Profit_Temp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   if(Profit_Temp>=0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Buy_Winner++;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Buy_Profit += Profit_Temp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Profit_Buy += Profit_Temp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   if(PositionGetInteger(POSITION_MAGIC)==Magic_Aux) <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Pos_Open++;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Aux_Position++;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Profit_Temp = PositionGetDouble(POSITION_PROFIT) + PositionGetDouble(POSITION_VOLUME)*CommMult + PositionGetDouble(POSITION_SWAP);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Profit_Aux += Profit_Temp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   //if(OrderLots()>Aux_Lots_Cached) i did not comment out this line<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Aux_Lots_Cached += PositionGetDouble(POSITION_VOLUME); //orderlots returns amount of lots for selected order<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   if(PositionType==POSITION_TYPE_BUY) //buy operation<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(PositionGetDouble(POSITION_PRICE_OPEN)>Buy_Open_Price_Cached) //BOPC set to 0 by default<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Buy_Open_Price_Cached=PositionGetDouble(POSITION_PRICE_OPEN);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Aux_Direction=1; //zero by default<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   if(PositionType==POSITION_TYPE_SELL) //sell operation<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(PositionGetDouble(POSITION_PRICE_OPEN)<Sell_Open_Price_Cached) //SOPC set to 10000 by default<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Sell_Open_Price_Cached=PositionGetDouble(POSITION_PRICE_OPEN);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Aux_Direction=-1;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   <br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br>  }<br><br>if(Counting!=Aux_Position) //counting is zero by default<br>  {<br>  a=-1;<br>  b=-1;<br>  Counting=Aux_Position;<br>  }<br>//Neutralization cancel<br>if(Neutralize!=0 && Aux_Position==0) //neutralize and repopulate set to zero by default<br>  {<br>  Neutralize=0;<br>  Repopulate=1;<br>  Print("Neutralization over !");<br>  }<br><br>double Profit=0;<br>double Buy_Loss_Cached=0, Sell_Loss_Cached=0, Buy_Profit_Cached=0, Sell_Profit_Cached=0;<br>int Worst_Buy_Position=0, Worst_Sell_Position=0, Best_Buy_Position=0, Best_Sell_Position=0;<br>double Worst_Buy_Price=0, Worst_Sell_Price=0, Best_Buy_Price=0, Best_Sell_Price=0;<br>int i=0, pos=0, v=-1, w=-1, x=-1, y=-1, z=-1;<br>int index=0, Aux_Position_Ticket=0;<br>static int Temp_Stop=0;<br><br>ResetOrderArray(Buy_Loss_Array, Buy_Profit_Array, Sell_Loss_Array, Sell_Profit_Array, Aux_Array); //custom function, sets all indexed values to zero<br>static datetime Time_Cached;<br>static int WSP_Cached=0, WBP_Cached=0;<br>static int d=0, e=0;<br><br>if(Repopulate==1) //will equal 1 if neutralize was not zero and aux position was zero<br>  {<br>  ResetOrderArrayTarget(Aux_Array_Target); //sets all indexed values to zero<br>  while(Aux_Array_Target[c][0]!=0 || Aux_Array_Target[c][1]!=0) //c = 0. if any index in AAT is not 0, increases c.<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;c++;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>  d=0;<br>  e=0;<br>  Repopulate=0;<br>  }<br><br>Profit = Profit_Buy + Profit_Sell + Profit_Aux; //profit set to zero by default<br><br>//Neutralization seems to offset failing trades?<br>//section to manage existing trades?<br>if(Neutralize==0 && (Buy_Position>=MathFloor(MaxPos/2) || Sell_Position>=MathFloor(MaxPos/2)) && Neutralizer==1) //mathfloor rounds down to nearest integer. neutralizeR is set to true by default<br>{//Maxpos is Maxcountstepsbuy by default, which is 10 by default (now 7), which is "number of cranks". buy/sell_position set to zero on each tick but increases if magic number detected<br>for(pos=PositionsTotal()-1; pos>=0; pos--) //for all open positions<br>  {<br>  if(PositionGetTicket(pos)>0) //returns true if position is found. selects the index of an order in the order pool, select by pos. mode = trades means active trades<br>&nbsp;&nbsp;&nbsp;&nbsp;{   <br>&nbsp;&nbsp;&nbsp;&nbsp;if(PositionGetInteger(POSITION_MAGIC)==Magic_Buy)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;Profit_Temp = PositionGetDouble(POSITION_PROFIT) + PositionGetDouble(POSITION_VOLUME)*CommMult + PositionGetDouble(POSITION_SWAP); //calculates profit as before but doesn't increase pos open and buy position<br>&nbsp;&nbsp;&nbsp;&nbsp;if(0>Profit_Temp) //if profit temp from this buy order is negative. adds trades to negative array<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;  Buy_Loss_Cached=NormalizeDouble(Profit_Temp,2); //round to 2 decimal places<br>&nbsp;&nbsp;&nbsp;&nbsp;  Worst_Buy_Position=PositionGetInteger(POSITION_TICKET); //returns ticket number of current ticket and sets it to a variable<br>&nbsp;&nbsp;&nbsp;&nbsp;  Worst_Buy_Price=PositionGetDouble(POSITION_PRICE_OPEN); //returns open price and sets it to a variable<br>&nbsp;&nbsp;&nbsp;&nbsp;  w++; //increases w by 1<br>&nbsp;&nbsp;&nbsp;&nbsp;  Buy_Loss_Array[w][0]=Worst_Buy_Position; //indexes WBP to position w, 0 (w will be at least 1)<br>&nbsp;&nbsp;&nbsp;&nbsp;  Buy_Loss_Array[w][1]=Buy_Loss_Cached; //indexes BLC to same array as above but position w, 1. BLC defined as profit temp rounded to 2 dp<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(Sell_Signal==1 && d<Buy_Position //sellsignal determined by all of those indicators. buy position counted earlier<br>&nbsp;&nbsp;&nbsp;&nbsp;  && CountBuyOrders()==Buy_Loser && CountBuyPips()/CountBuyOrders()<-Pips_Threshold) //countbuyorders = custom functions. counts number of buy orders, countbuypips counts pips buy orders.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ //PT set at 100 by default. <- = less than negative PT?. above statement is basically: if all buy orders are unprofitable<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Aux_Array_Target[][2]. Infinite x elements allowed, but only 2 y elements. Then resized to maxpos*4. Then all values set to 0<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArraySort(Aux_Array_Target);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index=ArrayBsearch(Aux_Array_Target, Worst_Buy_Position); //searches through a multidimensional array for a value. works differently in MQl5, only takes 2 arguments<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// looks for worst buy position in aux array target and returns its index. index is 0 by default, then changes based on found index.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// if value not found, returns index of element nearest in value<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(Aux_Array_Target[index][0]!=Worst_Buy_Position)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{//if the found index is not the worst buy position. <br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a=index;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//I have changed this code. The array is sorted ascending, is searched ascending, and "a" now decreases in the while loop.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(Aux_Array_Target[a][0]!=0 && !IsStopped()) //is stopped returns true if user or something else tries to shut down the program<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  a--; //while the ath element (containing index value of worst buy position) of x and the first position of y is not zero, increase a by 1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d++;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Counting++; //was zero, but now set to aux position, now increased by 1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Aux_Array_Target[a][0]=Worst_Buy_Position; //now it will definitely be set to worst buy position<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Aux_Array_Target[a][1]=0; //sets second index of y position to 0<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(Neutralize==0) //should be zero after earlier function?<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Print("Neutralization starting... Pips : " + DoubleToString(CountBuyPips()/CountBuyOrders(),2));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Print("Neutralize: ", Neutralize, " Positions Total: ", PositionsTotal() );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Time_Cached=OrderLaunch("SELL", Aux_Array_Target, a, PositionGetDouble(POSITION_VOLUME), CountBuyOrders()); <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//orderlaunch opens trades and returns time.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//if buy trades are open, sells worst buy position if unprofitable<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Temp_Stop=1; //initially zero<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Neutralize=-1;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;if(0<Profit_Temp) //if buy positions are open and profitable, add ticket and value to profitable arrays<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;  Buy_Profit_Cached=NormalizeDouble(Profit_Temp,2);<br>&nbsp;&nbsp;&nbsp;&nbsp;  Best_Buy_Position=PositionGetInteger(POSITION_TICKET);<br>&nbsp;&nbsp;&nbsp;&nbsp;  Best_Buy_Price=PositionGetDouble(POSITION_PRICE_OPEN);<br>&nbsp;&nbsp;&nbsp;&nbsp;  x++;<br>&nbsp;&nbsp;&nbsp;&nbsp;  Buy_Profit_Array[x][0]=Best_Buy_Position;<br>&nbsp;&nbsp;&nbsp;&nbsp;  Buy_Profit_Array[x][1]=Buy_Profit_Cached;<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;if(PositionGetInteger(POSITION_MAGIC)==Magic_Sell) //same procedure for sell orders<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;Profit_Temp = PositionGetDouble(POSITION_PROFIT) + PositionGetDouble(POSITION_VOLUME)*CommMult + PositionGetDouble(POSITION_SWAP);<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;if(0>Profit_Temp)<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;  Sell_Loss_Cached=NormalizeDouble(Profit_Temp,2);<br>&nbsp;&nbsp;&nbsp;&nbsp;  Worst_Sell_Position=PositionGetInteger(POSITION_TICKET);<br>&nbsp;&nbsp;&nbsp;&nbsp;  Worst_Sell_Price=PositionGetDouble(POSITION_PRICE_OPEN);<br>&nbsp;&nbsp;&nbsp;&nbsp;  y++;<br>&nbsp;&nbsp;&nbsp;&nbsp;  Sell_Loss_Array[y][0]=Worst_Sell_Position;<br>&nbsp;&nbsp;&nbsp;&nbsp;  Sell_Loss_Array[y][1]=Sell_Loss_Cached;<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(Buy_Signal==1 && e<Sell_Position<br>&nbsp;&nbsp;&nbsp;&nbsp;  && CountSellOrders()==Sell_Loser && CountSellPips()/CountSellOrders()<-Pips_Threshold)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArraySort(Aux_Array_Target);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index=ArrayBsearch(Aux_Array_Target, Worst_Sell_Position);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(Aux_Array_Target[index][0]!=Worst_Sell_Position)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b=index;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(Aux_Array_Target[b][0]!=0 && !IsStopped())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  b--;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e++;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Counting++;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Aux_Array_Target[b][0]=Worst_Sell_Position;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Aux_Array_Target[b][1]=0;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(Neutralize==0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Print("Neutralization starting... Pips : " + DoubleToString(CountSellPips()/CountSellOrders(),2));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Time_Cached=OrderLaunch("BUY", Aux_Array_Target, b, PositionGetDouble(POSITION_VOLUME), CountSellOrders()); //opens aux trades<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Temp_Stop=1;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Neutralize=1; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;if(0<Profit_Temp) //adds profitable sell orders to arrays<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;  Sell_Profit_Cached=NormalizeDouble(Profit_Temp,2);<br>&nbsp;&nbsp;&nbsp;&nbsp;  Best_Sell_Position=PositionGetInteger(POSITION_TICKET);<br>&nbsp;&nbsp;&nbsp;&nbsp;  Best_Sell_Price=PositionGetDouble(POSITION_PRICE_OPEN);<br>&nbsp;&nbsp;&nbsp;&nbsp;  z++;<br>&nbsp;&nbsp;&nbsp;&nbsp;  Sell_Profit_Array[z][0]=Best_Sell_Position;<br>&nbsp;&nbsp;&nbsp;&nbsp;  Sell_Profit_Array[z][1]=Sell_Profit_Cached;<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;if(PositionGetInteger(POSITION_MAGIC)==Magic_Aux) //stick aux trades into arrays, add temp profit to aux profit<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;  Profit_Temp = PositionGetDouble(POSITION_PROFIT) + PositionGetDouble(POSITION_VOLUME)*CommMult + PositionGetDouble(POSITION_SWAP);<br>&nbsp;&nbsp;&nbsp;&nbsp;  <br>&nbsp;&nbsp;&nbsp;&nbsp;  Aux_Profit=NormalizeDouble(Profit_Temp,2);<br>&nbsp;&nbsp;&nbsp;&nbsp;  Aux_Position_Ticket=PositionGetInteger(POSITION_TICKET);<br>&nbsp;&nbsp;&nbsp;&nbsp;  v++;<br>&nbsp;&nbsp;&nbsp;&nbsp;  Aux_Array[v][0]=Aux_Position_Ticket;<br>&nbsp;&nbsp;&nbsp;&nbsp;  Aux_Array[v][1]=Aux_Profit;<br>&nbsp;&nbsp;&nbsp;&nbsp;  Aux_Profit += Profit_Temp; //why does profit get added twice?<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>  }<br>}<br>//end of Neutralization section<br><br>int u=0;<br>string Order_Ticket_Proxy;<br>double Temp_Loss=0, Temp_Win=0, Temp_Equal=0, Temp_Aux=0;<br>double Loss_Cached=0, Aux_Cached=0, Loss_Sell_Cached=10000, Loss_Buy_Cached=10000;<br>string Loss_Buy_Ticket_Cached, Loss_Sell_Ticket_Cached, Loss_Ticket_Cached, Win_Ticket_Cached, Aux_Ticket_Cached;<br><br>//Closing Aux Positions <br>if(Neutralize!=0 && Aux_Position!=0 && Profit_Aux>=0) //if aux positions exist<br>  {<br>  if((Aux_Direction==1 && Sell_Position==0) || (Aux_Direction==-1 && Buy_Position==0))<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;for(i=PositionsTotal()-1; i>=0; i--)<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(PositionGetTicket(i)>0){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(PositionGetInteger(POSITION_MAGIC)==Magic_Aux){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  CloseSelected(IntegerToString(PositionGetInteger(POSITION_TICKET)), Retry);}} //custom function, closes the position<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;Alert("Closing all Aux Positions");<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>  }<br>//if neutralizer is on. The second criteria are guaranteed to be true.<br>//goes through arrays, pulls tickets of unprofitable Buy and sell trades, and all aux trades<br>if(Neutralize!=0 && (Aux_Profit+Loss_Sell_Cached>=0 || Aux_Profit+Loss_Buy_Cached>=0))<br>  {<br><br>  Loss_Buy_Cached=0;<br>  Loss_Sell_Cached=0;<br>  Aux_Cached=0;<br>  <br>  ArraySort(Buy_Loss_Array);<br>  ArraySort(Sell_Loss_Array);<br>  ArraySort(Aux_Array);  <br>  ArrayReverse(Aux_Array); //needed to be sorted descending!<br>  <br>  for(u=0; u<MaxPos*4; u++) //adding stuff to arrays<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;Temp_Loss=Buy_Loss_Array[u][1]; //temp loss initially zero<br>&nbsp;&nbsp;&nbsp;&nbsp;if(Temp_Loss<Loss_Buy_Cached) //LBC initially 0<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;  Loss_Buy_Cached=Temp_Loss;<br>&nbsp;&nbsp;&nbsp;&nbsp;  Loss_Buy_Ticket_Cached=DoubleToString(Buy_Loss_Array[u][0],0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;Temp_Loss=Sell_Loss_Array[u][1];<br>&nbsp;&nbsp;&nbsp;&nbsp;if(Temp_Loss<Loss_Sell_Cached)<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;  Loss_Sell_Cached=Temp_Loss;<br>&nbsp;&nbsp;&nbsp;&nbsp;  Loss_Sell_Ticket_Cached=DoubleToString(Sell_Loss_Array[u][0],0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;Temp_Aux=Aux_Array[u][1]; //all aux trades, profitable and unprofitable<br>&nbsp;&nbsp;&nbsp;&nbsp;if(Temp_Aux>Aux_Cached)<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;  Aux_Cached=Temp_Aux;<br>&nbsp;&nbsp;&nbsp;&nbsp;  Aux_Ticket_Cached=DoubleToString(Aux_Array[u][0],0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>  if(PositionSelectByTicket(StringToInteger(Aux_Ticket_Cached))==true) //compares the aux ticket profit with that of an opposing buy/sell ticket. If the pair are profitable, both are closed.<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(PositionGetInteger(POSITION_MAGIC)==Magic_Aux)<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;  Aux_Profit=PositionGetDouble(POSITION_PROFIT) + PositionGetDouble(POSITION_VOLUME)*CommMult + PositionGetDouble(POSITION_SWAP);<br>&nbsp;&nbsp;&nbsp;&nbsp;  Order_Ticket_Proxy=IntegerToString(PositionGetInteger(POSITION_TICKET));<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(PositionType==POSITION_TYPE_BUY && Aux_Profit+Loss_Sell_Cached>=0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseSelected(Loss_Sell_Ticket_Cached, Retry);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseSelected(Order_Ticket_Proxy, Retry);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(PositionType==POSITION_TYPE_SELL && Aux_Profit+Loss_Buy_Cached>=0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseSelected(Loss_Buy_Ticket_Cached, Retry);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseSelected(Order_Ticket_Proxy, Retry);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br>  }<br><br>double Lot_Size_Empowered=0;<br>int Order_Number=0;<br>//opens opposing auxiliary trades to existing ones. There needs to be at least one existing aux trade and they have to be unprofitable.<br><br>if(((Neutralize==1 && Sell_Position==0 && Sell_Signal!=0) || (Neutralize==-1 && Buy_Position==0 && Buy_Signal!=0)) && Profit_Aux<0) //opening positions trigger<br>  {<br>//have no sell positions open, but at least one buy aux position. This opens an opposite (sell) trade.<br>   if(Neutralize==1 && Sell_Position==0 && Sell_Signal!=0 && Buy_Open_Price_Cached-Aux_Threshold*Aux_Position*n*_Point>Bid) //_point gives point size of the quote currency<br>&nbsp;&nbsp;&nbsp;&nbsp; { //bid should be symbol_bid<br>&nbsp;&nbsp;&nbsp;&nbsp; Lot_Size_Empowered=NormalizeDouble(Aux_Lots_Cached*Aux_Position,2); //lot size is larger if more aux trades exist<br>&nbsp;&nbsp;&nbsp;&nbsp; if(CheckVolumeValue(Lot_Size_Empowered)==true && CheckMoneyForTrade(_Symbol, Lot_Size_Empowered, POSITION_TYPE_SELL)==true)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp; for(i=0; i<Retry; i++) //retry up to 5 times, but break if successful<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Order_Number=-1; //removed refreshrates<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Order_Number = AuxTradeOrderSend(Magic_Aux, Lot_Size_Empowered, Slippage, ORDER_TYPE_SELL, clrGold); //didn't include the gold arrow<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Print("AuxTradeOrderSell");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  if(Order_Number>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp; Print("RPG SELL - Mode ON = ", Buy_Open_Price_Cached, ". Aux Direction = ", Aux_Direction); //RPG = ?<br>&nbsp;&nbsp;&nbsp;&nbsp; Temp_Stop=1;<br>&nbsp;&nbsp;&nbsp;&nbsp; Neutralize=2;<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   <br>   if(Neutralize==-1 && Buy_Position==0 && Buy_Signal!=0 && Sell_Open_Price_Cached+Aux_Threshold*Aux_Position*n*_Point<Ask)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp; Lot_Size_Empowered=NormalizeDouble(Aux_Lots_Cached*Aux_Position,2);<br>&nbsp;&nbsp;&nbsp;&nbsp; if(CheckVolumeValue(Lot_Size_Empowered)==true && CheckMoneyForTrade(_Symbol, Lot_Size_Empowered, POSITION_TYPE_BUY)==true)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp; for(i=0; i<Retry; i++)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Order_Number=-1; //removed refreshrates<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Order_Number=AuxTradeOrderSend(Magic_Aux, Lot_Size_Empowered, Slippage, ORDER_TYPE_BUY, clrGold);//opening buy position if all signals are good<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Print("AuxTradeOrderBuy");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  if(Order_Number>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp; Print("RPG BUY - Mode ON = ", Sell_Open_Price_Cached, ". Aux Direction = ", Aux_Direction);<br>&nbsp;&nbsp;&nbsp;&nbsp; Temp_Stop=1;<br>&nbsp;&nbsp;&nbsp;&nbsp; Neutralize=-2;<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   <br>  }<br><br>if(Neutralize!=0 && Profit>=0)<br>  {<br>  while (CloseAll() == AT_LEAST_ONE_FAILED) //closeall function returns an integer that was originally a boolean. here, it is returning "2". <br>   {//maybe if trade execution was unsuccessful, this is saying "wait a second" before trying again?<br>&nbsp;&nbsp;&nbsp;&nbsp;  Sleep(1000);<br>   }<br>  }<br><br>if(Temp_Stop==1)<br>  {<br>  if(Buy_Signal==0 && Sell_Signal==0){<br>&nbsp;&nbsp;&nbsp;&nbsp;Temp_Stop=0;}<br>  Sell_Signal=0; <br>  Buy_Signal=0;<br>  }<br><br>//--<br><br>static int ticker=0;<br><br>   if(DayOfWeekMQL4()==0 || (DayOfWeekMQL4()==1 && HourMQL4()==0) || DayOfWeekMQL4()==6 || (DayOfWeekMQL4()==5 && HourMQL4()==23) || Stoptrading==true) //disable trading at certain times<br>&nbsp;&nbsp;&nbsp;&nbsp; {//sunday = 0. <br>&nbsp;&nbsp;&nbsp;&nbsp;  if(Showinfopanel==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; allowbuy="Trade is stopped!";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; allowsell="Trade is stopped!";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetTextMQL4("Info_9",allowbuy,10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetTextMQL4("Info_19",allowsell,10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  return;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Do nothing at weekend & first and last hour of trading week<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp; <br>   if(StopTradesLevel==true) //Here we check crossing price and critical levels. false by default<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(Ask<BuyStopLevel)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AllowafterlevelBuy=false;<br>&nbsp;&nbsp;&nbsp;&nbsp;  else AllowafterlevelBuy=true;<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(Bid>SellStopLevel)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AllowafterlevelSell=false;<br>&nbsp;&nbsp;&nbsp;&nbsp;  else AllowafterlevelSell=true;<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp; <br>   if(Showinfopanel==true) //should there be brackets here?<br>&nbsp;&nbsp;&nbsp;&nbsp;  UpdateBasketStatus();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Update data for info-panel<br>&nbsp;&nbsp;&nbsp;&nbsp;  <br>   //if(lastopentime!=Time[0]) //Opening new orders is in the new candle<br>   //  {<br>//Volatility Filter turn off<br>&nbsp;&nbsp;&nbsp;&nbsp;  if (Usefiltrevolat==true)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //If we have limitation of sharp change<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CheckPriceSpeed(); //disables trades if volatility is too high, and sets "allow" variables to false, and closes existing trades<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;  CCI_1 = CCIcheck(Period_CCI, PRICE_CLOSE, 1); //Commodity Channel Index indicator. Similar to RSI<br>&nbsp;&nbsp;&nbsp;&nbsp;  CCI_2 = CCIcheck(Period_CCI, PRICE_CLOSE, 2);<br>&nbsp;&nbsp;&nbsp;&nbsp;  <br>//Triggers only if there are no active buy/sell orders, hence "first orders"<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(CountBuyOrders()==0 && Allowbuy==true && AllowafterlevelBuy==true && Allowbuylevel==true && Buy_Signal==1 && Neutralize<2) //Here we define a conditions for the first buy orders<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;  <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AlertMaxStepsBuy=false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(CCIFiltre==false){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OpenFirstOrder(ORDER_TYPE_BUY); //opens trades<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(CCI_1>0 && CCI_2<0){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   OpenFirstOrder(ORDER_TYPE_BUY); //opens trades<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(CountSellOrders()==0 && Allowsell==true && AllowafterlevelSell==true && Allowselllevel==true && Sell_Signal==1 && Neutralize>-2) //Here we define a conditions for the first sell orders<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AlertMaxStepsSell=false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(CCIFiltre==false){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OpenFirstOrder(ORDER_TYPE_SELL); //opens trades<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(CCI_1<0 && CCI_2>0){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   OpenFirstOrder(ORDER_TYPE_SELL); //opens trades<br>}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>   //   lastopentime=Time[0];<br>   //  }<br>//opens more trades if current ones are successful?<br>   if(CountBuyOrders()>0 && (Allowbuy==true || Stopmode_2==s) && (AllowafterlevelBuy==true || Stopmode_3==s) && Buy_Signal==1 && Neutralize<2) //Here we define a conditions for the next buy orders<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  lastticket=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;  lastbuyprice=Findlastprice(POSITION_TYPE_BUY); //should update lastticket<br>&nbsp;&nbsp;&nbsp;&nbsp;  step=FindStepSize(POSITION_TYPE_BUY);<br>&nbsp;&nbsp;&nbsp;&nbsp;  nextlot=DetermineLot(lastticket);<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(Ask<(lastbuyprice-step))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MarginAgreed=CheckMoneyForTrade(_Symbol,nextlot,POSITION_TYPE_BUY);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(MarginAgreed==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lastTP=FindLastTP(POSITION_TYPE_BUY);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OpenNewLevel(lastTP,nextlot,ORDER_TYPE_BUY); //openstrades<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Print("Pips Delta BUY = " + DoubleToString(CountBuyPips()/CountBuyOrders(),2));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(Showinfopanel==true && step!=100000)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(Digits()==3 || Digits()==5)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buystepvalue=step/10/Point();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else buystepvalue=step/Point();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nextpricebuy=lastbuyprice-step;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nextlotbuy=nextlot;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   if(CountSellOrders()>0 && (Allowsell==true || Stopmode_2==s) && (AllowafterlevelSell==true || Stopmode_3==s) && Sell_Signal==1 && Neutralize>-2) //Here we define a conditions for the next sell orders<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  lastticket=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;  lastsellprice=Findlastprice(POSITION_TYPE_SELL);&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;  step=FindStepSize(POSITION_TYPE_SELL);<br>&nbsp;&nbsp;&nbsp;&nbsp;  nextlot=DetermineLot(lastticket);<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(Bid>(lastsellprice+step))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MarginAgreed=CheckMoneyForTrade(_Symbol,nextlot,POSITION_TYPE_SELL);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(MarginAgreed==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lastTP=FindLastTP(POSITION_TYPE_SELL);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OpenNewLevel(lastTP,nextlot,ORDER_TYPE_SELL); //opens trades<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Print("Pips Delta SELL = ", DoubleToString(CountSellPips()/CountSellOrders(),2));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(Showinfopanel==true && step!=100000)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(Digits()==3 || Digits()==5)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sellstepvalue=step/10/Point();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else sellstepvalue=step/Point();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nextpricesell=lastsellprice+step;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nextlotsell=nextlot;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>// Manual input close trades   <br>   if(Allowbuy==false && Stopmode_2==a && CountBuyOrders()>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;  Closedirection(POSITION_TYPE_BUY); //closes trades of one type<br>   if(Allowsell==false && Stopmode_2==a && CountSellOrders()>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;  Closedirection(POSITION_TYPE_SELL); //closes trades of one type<br>   if(AllowafterlevelBuy==false && Stopmode_3==a && CountBuyOrders()>0)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  Closedirection(POSITION_TYPE_BUY); //closes trades<br>&nbsp;&nbsp;&nbsp;&nbsp;  Allowbuylevel=false;<br>&nbsp;&nbsp;&nbsp;&nbsp;  Print("Price is lower than critical level! Buy orders are prohibited!");<br>&nbsp;&nbsp;&nbsp;&nbsp;  Alert("Price is lower than critical level! Buy orders are prohibited!");<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   if(AllowafterlevelSell==false && Stopmode_3==a && CountSellOrders()>0)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  Closedirection(POSITION_TYPE_SELL); //closes trades<br>&nbsp;&nbsp;&nbsp;&nbsp;  Allowselllevel=false;<br>&nbsp;&nbsp;&nbsp;&nbsp;  Print("Price is higher than critical level! Sell orders are prohibited!");<br>&nbsp;&nbsp;&nbsp;&nbsp;  Alert("Price is higher than critical level! Sell orders are prohibited!");<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   if(Showinfopanel==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;  ticker++;<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(ticker>10)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ticker=1;<br>&nbsp;&nbsp;&nbsp;&nbsp;  UpdateInfoWindow(ticker, Neutralize);<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br>  } //Ontick ends<br>//+------------------------------------------------------------------+<br>//| Function of price speed calculation for the last day&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br>//+------------------------------------------------------------------+<br>void CheckPriceSpeed()<br>  {<br>&nbsp;&nbsp;&nbsp;&nbsp; MqlRates bar[];<br>&nbsp;&nbsp;&nbsp;&nbsp; ArraySetAsSeries(bar, true);<br>&nbsp;&nbsp;&nbsp;&nbsp; CopyRates(_Symbol, PERIOD_CURRENT, 0, 1500, bar);<br>&nbsp;&nbsp;&nbsp;&nbsp; double urgentlevel, pricediffer;<br>&nbsp;&nbsp;&nbsp;&nbsp; int number;<br>&nbsp;&nbsp;&nbsp;&nbsp; switch (Period())&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //because speed of price for one day defines in the new candle of chart<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case PERIOD_M1:  number=1441; break; //no of 1M periods in day +1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case PERIOD_M5:  number=289;  break; //no of 5M periods in day +1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case PERIOD_M15: number=97;   break; //no of 15M periods in day +1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case PERIOD_M30: number=49;   break; //no of 30M periods in day +1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case PERIOD_H1:  number=25;   break; //no of 1H periods in day +1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case PERIOD_H4:  number=7;&nbsp;&nbsp;&nbsp;&nbsp;break; //no of 4H periods in day +1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; number=2;&nbsp;&nbsp;&nbsp;&nbsp;break; //no of 24H periods in day +1<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp; urgentlevel = Volatility(Periodvolatility_2)*Lineofvolatility; //LOV = 1 by default, periodvolatility is 20 by default. volatility is defined function based on daily highs and lows<br>&nbsp;&nbsp;&nbsp;&nbsp; pricediffer = bar[1].close-bar[number].close;<br>&nbsp;&nbsp;&nbsp;&nbsp; if (urgentlevel<MathAbs(pricediffer))<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (Stopmode_4==all)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   UrgentCloseOrders(); <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Print("SyTurn stops trade, due to volatility exceeding threshold!");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Alert("SyTurn stops trade, due to volatility exceeding threshold!");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Allowsell=false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Allowbuy=false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Stoptrading=true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   if (Showinfopanel==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Flagsellinfo=true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Flagbuyinfo=true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   if (pricediffer>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  if (CountSellOrders()>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Closedirection(POSITION_TYPE_SELL);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  if (Alertsellvolat==false)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Print("SyTurn stops sell orders, due to volatility exceeding threshold!");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Alert("SyTurn stops sell orders, due to volatility exceeding threshold!");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Alertsellvolat=true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Allowsell=false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  if (Showinfopanel==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Flagsellinfo=true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   if (pricediffer<0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  if (CountBuyOrders()>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Closedirection(POSITION_TYPE_BUY);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  if (Alertbuyvolat==false)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Print("SyTurn stops buy orders, due to volatility exceeding threshold!");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Alert("SyTurn stops buy orders, due to volatility exceeding threshold!");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Alertbuyvolat=true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Allowbuy=false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  if (Showinfopanel==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Flagbuyinfo=true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>  }<br>//+------------------------------------------------------------------+<br>//| Function of all one-direction-orders forced closure&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  |<br>//+------------------------------------------------------------------+<br>void Closedirection(ENUM_POSITION_TYPE ordertype)<br>  {<br>   MqlTick last_tick;<br>   SymbolInfoTick(_Symbol,last_tick);<br>   double Bid=last_tick.bid;<br>   double Ask=last_tick.ask;<br>   for(int i=PositionsTotal()-1; i>=0; i--)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(PositionGetTicket(i)>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if((PositionGetString(POSITION_SYMBOL)==Symbol() && PositionGetInteger(POSITION_MAGIC)==Magic_Buy) || (PositionGetInteger(POSITION_MAGIC)==Magic_Sell && PositionGetInteger(POSITION_TYPE) == ordertype))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(PositionGetInteger(POSITION_TYPE)==POSITION_TYPE_BUY)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   OrderClosex(ORDER_TYPE_BUY, PositionGetInteger(POSITION_TICKET),PositionGetDouble(POSITION_VOLUME),Bid,Slippage,clrBlack);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(PositionGetInteger(POSITION_TYPE)==POSITION_TYPE_SELL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   OrderClosex(ORDER_TYPE_SELL, PositionGetInteger(POSITION_TICKET),PositionGetDouble(POSITION_VOLUME),Ask,Slippage,clrBlack);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>  }<br>//+------------------------------------------------------------------+<br>//| Function of all orders closing when critical drawdown&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<br>//+------------------------------------------------------------------+<br>void UrgentCloseOrders()<br>  {<br>   MqlTick last_tick;<br>   SymbolInfoTick(_Symbol,last_tick);<br>   double Bid=last_tick.bid;<br>   double Ask=last_tick.ask;<br>   for(int i=PositionsTotal()-1; i>=0; i--)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(PositionGetTicket(i)>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(PositionGetString(POSITION_SYMBOL)==Symbol() && (PositionGetInteger(POSITION_MAGIC)==Magic_Buy || PositionGetInteger(POSITION_MAGIC)==Magic_Sell))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(PositionGetInteger(POSITION_TYPE)==POSITION_TYPE_BUY)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   OrderClosex(ORDER_TYPE_BUY, PositionGetInteger(POSITION_TICKET),PositionGetDouble(POSITION_VOLUME),Bid,Slippage,clrBlack);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(PositionGetInteger(POSITION_TYPE)==POSITION_TYPE_SELL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   OrderClosex(ORDER_TYPE_SELL, PositionGetInteger(POSITION_TICKET),PositionGetDouble(POSITION_VOLUME),Ask,Slippage,clrBlack);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   return;<br>  }<br><br>//+------------------------------------------------------------------+<br>//| Function of previous grid step calculation&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   |<br>//+------------------------------------------------------------------+<br>double FindLastStep(ENUM_POSITION_TYPE order_type)<br>  {<br>   double nowprice=0,oldstep=0;<br>   if(order_type==POSITION_TYPE_BUY)<br>&nbsp;&nbsp;&nbsp;&nbsp;  nowprice=1000000;<br>   for(int i=PositionsTotal()-1; i>=0; i--)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(PositionGetTicket(i)>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(PositionGetString(POSITION_SYMBOL)==Symbol() && (PositionGetInteger(POSITION_MAGIC)==Magic_Buy || PositionGetInteger(POSITION_MAGIC)==Magic_Sell) && PositionGetInteger(POSITION_TYPE)==order_type)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(PositionGetInteger(POSITION_TICKET)!=lastticket)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   if(PositionGetInteger(POSITION_TYPE)==POSITION_TYPE_BUY)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  if(nowprice>PositionGetDouble(POSITION_PRICE_OPEN)) //Here we find the last grid order price<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nowprice=PositionGetDouble(POSITION_PRICE_OPEN);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   if(PositionGetInteger(POSITION_TYPE)==POSITION_TYPE_SELL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  if(nowprice<PositionGetDouble(POSITION_PRICE_OPEN))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nowprice=PositionGetDouble(POSITION_PRICE_OPEN);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   if(PositionSelectByTicket(lastticket))<br>&nbsp;&nbsp;&nbsp;&nbsp;  oldstep=MathAbs(nowprice-PositionGetDouble(POSITION_PRICE_OPEN)); //step is a difference of open prices of last and penultimate orders<br>   return(oldstep);<br>  }<br>//+------------------------------------------------------------------+<br>//| Function of new cranks opening&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   |<br>//+------------------------------------------------------------------+<br>void OpenNewLevel(double previousTP,double LOT,int Type)<br>  {<br>   MqlTick last_tick;<br>   SymbolInfoTick(_Symbol,last_tick);<br>   double Bid=last_tick.bid;<br>   double Ask=last_tick.ask;<br>   double currentTPlevel,currentTP;<br>   int Level, Ticket;<br>   currentTP=previousTP;<br><br>   if(Type==ORDER_TYPE_BUY)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  Level=CountBuyOrders();<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(Useaverageprofit==false) //if take-profites are constant<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(Usedynamictakeprofit==true) //in case of dynamic take-profit<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentTP=FindDynamicTP(Level,previousTP);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentTPlevel=NormalizeDouble(Ask+currentTP,Digits()); //removed refreshrates<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ECNflag==false){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OrderSendx(Symbol(),ORDER_TYPE_BUY,LOT,Ask,Slippage,0,currentTPlevel,"SyTurn",Magic_Buy,0,clrBlue);<br>}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Ticket = OrderSendx(Symbol(),ORDER_TYPE_BUY,LOT,Ask,Slippage,0,0,"SyTurn",Magic_Buy,0,clrBlue);<br>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (Ticket>0 && PositionSelectByTicket(Ticket))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OrderModifyx(Ticket, PositionGetDouble(POSITION_PRICE_OPEN), 0, currentTPlevel, 0, clrNONE);<br>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  else&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //in case of necessity of average basket take-profit<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(Usedynamictakeprofit==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentTP=FindDynamicTP(Level,previousTP);&nbsp;&nbsp;&nbsp;&nbsp; //if take-profit is dynamic<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(Breakevenclose==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //in case of breakevenflag<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(Level>=StepforBE)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   currentTP=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //removed refreshrates<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OrderSendx(Symbol(),ORDER_TYPE_BUY,LOT,Ask,Slippage,0,0,"SyTurn",Magic_Buy,0,clrBlue);&nbsp;&nbsp;&nbsp;&nbsp;//opening without take-profites<br>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ModifyBasketOrders(POSITION_TYPE_BUY,currentTP);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>   if(Type==ORDER_TYPE_SELL)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  Level=CountSellOrders();<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(Useaverageprofit==false) //if take-profites are constant<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(Usedynamictakeprofit==true) //in case of dynamic take-profit<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentTP=FindDynamicTP(Level,previousTP);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //removed refreshrates<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; currentTPlevel=NormalizeDouble(Bid-currentTP,Digits());<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(ECNflag==false){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OrderSendx(Symbol(),ORDER_TYPE_SELL,LOT,Bid,Slippage,0,currentTPlevel,"SyTurn",Magic_Sell,0,clrRed);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Ticket = OrderSendx(Symbol(),ORDER_TYPE_SELL,LOT,Bid,Slippage,0,0,"SyTurn",Magic_Sell,0,clrRed);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (Ticket>0 && PositionSelectByTicket(Ticket))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OrderModifyx(Ticket, PositionGetDouble(POSITION_PRICE_OPEN), 0, currentTPlevel, 0, clrNONE);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  else&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //in case of necessity of average basket take-profit<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(Usedynamictakeprofit==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentTP=FindDynamicTP(Level,previousTP);&nbsp;&nbsp;&nbsp;&nbsp; //if take-profit is dynamic<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(Breakevenclose==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //in case of breakevenflag<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(Level>=StepforBE)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   currentTP=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //removedrefreshrates<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OrderSendx(Symbol(),ORDER_TYPE_SELL,LOT,Bid,Slippage,0,0,"SyTurn",Magic_Sell,0,clrRed);&nbsp;&nbsp;&nbsp;&nbsp;//opening without take-profites<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ModifyBasketOrders(POSITION_TYPE_SELL,currentTP);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>  }<br>//+------------------------------------------------------------------+<br>//| Modification of baskets orders&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   |<br>//+------------------------------------------------------------------+<br>void ModifyBasketOrders(ENUM_POSITION_TYPE o_type,double tpvalue)<br>  {<br>   double avgprice   = 0,<br>   order_lots = 0;<br>   double price=0,tp=0;<br>   for(int i=PositionsTotal()-1; i>=0; i--)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(PositionGetTicket(i)>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(PositionGetString(POSITION_SYMBOL)==Symbol() && (PositionGetInteger(POSITION_MAGIC)==Magic_Buy || PositionGetInteger(POSITION_MAGIC)==Magic_Sell) && PositionGetInteger(POSITION_TYPE)==o_type)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;price+=PositionGetDouble(POSITION_PRICE_OPEN)*PositionGetDouble(POSITION_VOLUME);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order_lots+=PositionGetDouble(POSITION_VOLUME);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   avgprice=NormalizeDouble(price/order_lots,Digits());&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //find average weghted price<br><br>   if(o_type==POSITION_TYPE_BUY)<br>&nbsp;&nbsp;&nbsp;&nbsp;  tp=NormalizeDouble(avgprice+tpvalue,Digits());&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //plus take-profit value<br>   if(o_type==POSITION_TYPE_SELL)<br>&nbsp;&nbsp;&nbsp;&nbsp;  tp=NormalizeDouble(avgprice-tpvalue,Digits());<br><br>   for(int i=PositionsTotal()-1; i>=0; i--)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(PositionGetTicket(i)>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(PositionGetString(POSITION_SYMBOL)==Symbol() && (PositionGetInteger(POSITION_MAGIC)==Magic_Buy || PositionGetInteger(POSITION_MAGIC)==Magic_Sell) && PositionGetInteger(POSITION_TYPE)==o_type)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OrderModifyx(PositionGetInteger(POSITION_TICKET),PositionGetDouble(POSITION_PRICE_OPEN),0,tp,0,clrNONE);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//orders modification one by one<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>  }<br>//+------------------------------------------------------------------+<br>//| Dynamic change of take-profit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<br>//+------------------------------------------------------------------+<br>double FindDynamicTP(int Stage,double TPbefore)<br>  {<br>   double findTP=TPbefore;<br>   if(Stage>=StepdynamicTP)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  findTP=TPbefore*K_TPDecrease;<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(findTP<MinTakeProfit*Point()) //if we did not identify conditions about dynamic take-profit, return the same<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; findTP=MinTakeProfit*Point();<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   return(findTP);<br>  }<br>//+------------------------------------------------------------------+<br>//| Find the value of previous take-profit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   |<br>//+------------------------------------------------------------------+<br>double FindLastTP(int Modetrade) //does this return the actual take profit price or just the difference?<br>  {<br>   double avgprice=0,order_lots=0;<br>   double price=0,take_profit=-1;<br><br>   if(Useaverageprofit==false) //we find all take-profits according last orders tickets<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(PositionSelectByTicket(lastticket))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(PositionGetInteger(POSITION_TYPE)==POSITION_TYPE_BUY)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;take_profit=PositionGetDouble(POSITION_TP)-PositionGetDouble(POSITION_PRICE_OPEN); //why does it subtract open price?<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(take_profit);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(PositionGetInteger(POSITION_TYPE)==POSITION_TYPE_SELL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;take_profit=PositionGetDouble(POSITION_PRICE_OPEN)-PositionGetDouble(POSITION_TP);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(take_profit);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   for(int i=PositionsTotal()-1; i>=0; i--)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(PositionGetTicket(i)>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(PositionGetString(POSITION_SYMBOL)==Symbol() && (PositionGetInteger(POSITION_MAGIC)==Magic_Buy || PositionGetInteger(POSITION_MAGIC)==Magic_Sell) && PositionGetInteger(POSITION_TYPE)==Modetrade)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;price+=PositionGetDouble(POSITION_PRICE_OPEN)*PositionGetDouble(POSITION_VOLUME);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order_lots+=PositionGetDouble(POSITION_VOLUME);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   avgprice=NormalizeDouble(price/order_lots,Digits());<br>   if(PositionSelectByTicket(lastticket))<br>&nbsp;&nbsp;&nbsp;&nbsp;  take_profit=MathAbs(PositionGetDouble(POSITION_TP)-avgprice);<br>   return(take_profit);<br>  }<br>//+------------------------------------------------------------------+<br>//| Next order lot calculation&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   |<br>//+------------------------------------------------------------------+<br>double DetermineLot(int previousticket)<br>  {<br>   double lastlot=0,lot_next;<br>   int level;<br>   long lasttype=2;<br>   double lot_step=SymbolInfoDouble(_Symbol,SYMBOL_VOLUME_STEP);<br>   double lot_max=SymbolInfoDouble(_Symbol,SYMBOL_VOLUME_MAX);<br><br>   if(PositionSelectByTicket(previousticket))<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  lastlot=PositionGetDouble(POSITION_VOLUME);<br>&nbsp;&nbsp;&nbsp;&nbsp;  lasttype=PositionGetInteger(POSITION_TYPE);<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   if(lasttype==POSITION_TYPE_BUY)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(ManuallotBuy>0) //in case of manual lot. Should stay at zero with current settings<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lot_next=MathFloor(ManuallotBuy/lot_step)*lot_step;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (lot_next>lot_max)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lot_next=lot_max;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return(lot_next);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  level=CountBuyOrders();<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(level>=Multipusestep) //if amount of orders is more than starts amount, take multiplier. 1 by default<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lot_next=MathFloor((lastlot*Multiplier)/lot_step)*lot_step;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (lot_next>lot_max)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lot_next=lot_max;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return(lot_next);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   if(lasttype==POSITION_TYPE_SELL)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(ManuallotSell>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lot_next=MathFloor(ManuallotSell/lot_step)*lot_step;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (lot_next>lot_max)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lot_next=lot_max;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return(lot_next);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  level=CountSellOrders();<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(level>=Multipusestep)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lot_next=MathFloor((lastlot*Multiplier)/lot_step)*lot_step;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (lot_next>lot_max)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lot_next=lot_max;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return(lot_next);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   return(lastlot);<br>  }<br>//+------------------------------------------------------------------+<br>//| Opened buy orders calculation&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<br>//+------------------------------------------------------------------+<br>int CountBuyOrders() <br>  {<br>   int count= 0;<br>   for(int i=0; i<PositionsTotal(); i++)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(PositionGetTicket(i)>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(PositionGetString(POSITION_SYMBOL)==Symbol() && (PositionGetInteger(POSITION_MAGIC)==Magic_Buy) && PositionGetInteger(POSITION_TYPE)==POSITION_TYPE_BUY){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count++;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   if(Showinfopanel==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;  currentstepbuy=count;<br>   return(count);<br>  }<br>  <br>double CountBuyPips()<br>  {<br>   MqlTick last_tick;<br>   SymbolInfoTick(_Symbol,last_tick);<br>   double Bid=last_tick.bid;<br>   double Ask=last_tick.ask;<br>  double pips=0, lots_total=0, pips_weighted=0;<br>  int k = 1;<br>  if(_Digits==3 || _Digits==5)<br>&nbsp;&nbsp;&nbsp;&nbsp;k=10;<br>  else<br>&nbsp;&nbsp;&nbsp;&nbsp;k=1;<br>  for(int i=0; i<PositionsTotal(); i++)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(PositionGetTicket(i)>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(PositionGetString(POSITION_SYMBOL)==Symbol() && (PositionGetInteger(POSITION_MAGIC)==Magic_Buy) && PositionGetInteger(POSITION_TYPE)==POSITION_TYPE_BUY)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   pips_weighted += ((PositionGetDouble(POSITION_PRICE_OPEN)-Bid)/k/_Point)/PositionGetDouble(POSITION_VOLUME);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   lots_total += PositionGetDouble(POSITION_VOLUME);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>  pips = pips_weighted*lots_total;<br>  if(pips<=0)<br>&nbsp;&nbsp;&nbsp;&nbsp;pips=MathAbs(pips);<br>  if(pips>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;pips=0-pips;<br>  return(pips);<br>  }<br>//+------------------------------------------------------------------+<br>//| Opened buy orders calculation&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<br>//+------------------------------------------------------------------+<br>int CountSellOrders()<br>  {<br>   int count= 0;<br>   for(int i=0; i<PositionsTotal(); i++)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(PositionGetTicket(i)>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(PositionGetString(POSITION_SYMBOL)==Symbol() && (PositionGetInteger(POSITION_MAGIC)==Magic_Sell) && PositionGetInteger(POSITION_TYPE)==POSITION_TYPE_SELL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count++;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   if(Showinfopanel==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;  currentstepsell=count;<br>   return(count);<br>  }<br>  <br>double CountSellPips()<br>  {<br>   MqlTick last_tick;<br>   SymbolInfoTick(_Symbol,last_tick);<br>   double Bid=last_tick.bid;<br>   double Ask=last_tick.ask;<br>  double pips=0, lots_total=0, pips_weighted=0;<br>  int k = 1;<br>  if(_Digits==3 || _Digits==5)<br>&nbsp;&nbsp;&nbsp;&nbsp;k=10;<br>  else<br>&nbsp;&nbsp;&nbsp;&nbsp;k=1;<br>  for(int i=0; i<PositionsTotal(); i++)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(PositionGetTicket(i)>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(PositionGetString(POSITION_SYMBOL)==Symbol() && (PositionGetInteger(POSITION_MAGIC)==Magic_Sell) && PositionGetInteger(POSITION_TYPE)==POSITION_TYPE_SELL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   pips_weighted += ((PositionGetDouble(POSITION_PRICE_OPEN)-Ask)/k/_Point)/PositionGetDouble(POSITION_VOLUME);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   lots_total += PositionGetDouble(POSITION_VOLUME); <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>  pips = pips_weighted*lots_total;&nbsp;&nbsp;&nbsp;&nbsp;<br>  return(pips);<br>  }<br>//+------------------------------------------------------------------+<br>//| Opening first order in the grid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  |<br>//+------------------------------------------------------------------+<br>void OpenFirstOrder(ENUM_ORDER_TYPE OTYPE)<br>  {<br>   MqlTick last_tick;<br>   SymbolInfoTick(_Symbol,last_tick);<br>   double Bid=last_tick.bid;<br>   double Ask=last_tick.ask;<br>   double firstlot=0,firstTP=0,lot_min=0;<br>   int Ticket=0;<br>   //lot_min=MarketInfo(Symbol(),MODE_MINLOT);<br>   //double lot_step=MarketInfo(Symbol(),MODE_LOTSTEP);<br>   //firstlot=(RiskDeposit/Howmuchmoney)*FirstLot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //define lot according moneymanagement<br>   //if(order_type==OP_BUY && ManuallotBuy>0)<br>   //   firstlot=ManuallotBuy;<br>   //if(order_type==OP_SELL && ManuallotSell>0)<br>   //   firstlot=ManuallotSell;<br>   //firstlot=MathFloor(firstlot/lot_step)*lot_step;<br><br>   //if(firstlot<lot_min)<br>   //   firstlot=lot_min;<br>   <br>int LotsDigit=0;<br>double MinLots=0, MaxLots=0, AcFrMar=0, Step=0, One_Lot=0;<br><br>MinLots=SymbolInfoDouble(_Symbol,SYMBOL_VOLUME_MIN);<br>MaxLots=SymbolInfoDouble(_Symbol,SYMBOL_VOLUME_MAX);<br><br>if(Money_Management==false)<br>   {<br>   firstlot=Lot_Size;<br>   }<br><br>if(Money_Management==true)<br>   {<br>   if (OTYPE == ORDER_TYPE_BUY){<br>&nbsp;&nbsp;&nbsp;&nbsp;  pricetype = SYMBOL_ASK;}<br>   if (OTYPE == ORDER_TYPE_SELL){<br>&nbsp;&nbsp;&nbsp;&nbsp;  pricetype = SYMBOL_BID;}<br>   <br>   bool success = OrderCalcMargin(OTYPE, _Symbol, 1, SymbolInfoDouble(_Symbol, pricetype), One_Lot); //was MODE_MARGINREQUIRED. SYMBOL_MARGIN_INITIAL doesn't work for forex<br>   <br>   Step=SymbolInfoDouble(_Symbol,SYMBOL_VOLUME_STEP);<br>   <br>   AcFrMar=NormalizeDouble(AccountInfoDouble(ACCOUNT_MARGIN_FREE),2);<br>   <br>   firstlot=MathFloor(AcFrMar*Margin_Percent/100/One_Lot/Step)*Step;<br>   }<br> <br>if(firstlot>MaxLots)<br>  firstlot=MaxLots;<br>if(firstlot<MinLots)<br>  firstlot=MinLots;<br>&nbsp;&nbsp;&nbsp;&nbsp;  <br>   if(OTYPE==ORDER_TYPE_BUY)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  firstTP=NormalizeDouble(Ask+Maintakeprofit*Point(),Digits()); //maintakeprofit is in pips. initially 10, then becomes 100<br>&nbsp;&nbsp;&nbsp;&nbsp;  if (ECNflag==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Ticket = OrderSendx(Symbol(),OTYPE,firstlot,Ask,Slippage,0,0,"SyTurn first trade",Magic_Buy,0,clrBlue);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (Ticket>0 && PositionSelectByTicket(Ticket))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OrderModifyx(Ticket, PositionGetDouble(POSITION_PRICE_OPEN), 0, firstTP, 0, clrNONE);<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;  else {OrderSendx(Symbol(),OTYPE,firstlot,Ask,Slippage,0,firstTP,"SyTurn first trade",Magic_Buy,0,clrBlue);}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   if(OTYPE==ORDER_TYPE_SELL)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  firstTP=NormalizeDouble(Bid-Maintakeprofit*Point(),Digits());<br>&nbsp;&nbsp;&nbsp;&nbsp;  if (ECNflag==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Ticket = OrderSendx(Symbol(),OTYPE,firstlot,Bid,Slippage,0,0,"SyTurn first trade",Magic_Sell,0,clrRed);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (Ticket>0 && PositionSelectByTicket(Ticket))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OrderModifyx(Ticket, PositionGetDouble(POSITION_PRICE_OPEN), 0, firstTP, 0, clrNONE);<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;  else {OrderSendx(Symbol(),OTYPE,firstlot,Bid,Slippage,0,firstTP,"SyTurn first trade",Magic_Sell,0,clrRed);<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>  }<br>//+------------------------------------------------------------------+<br>//| Finding last open price&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  |<br>//+------------------------------------------------------------------+<br>double Findlastprice(ENUM_POSITION_TYPE order_type)<br>  {<br>   double oldopenprice=0;<br>   long&nbsp;&nbsp;&nbsp;&nbsp;oldticket;<br><br>   aticket=0;<br><br>   for(int i=PositionsTotal()-1; i>=0; i--)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(PositionGetTicket(i)>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(PositionGetString(POSITION_SYMBOL)==Symbol() && (PositionGetInteger(POSITION_MAGIC)==Magic_Buy || PositionGetInteger(POSITION_MAGIC)==Magic_Sell) && PositionGetInteger(POSITION_TYPE)==order_type)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oldticket=PositionGetInteger(POSITION_TICKET);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(oldticket>aticket)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   oldopenprice=PositionGetDouble(POSITION_PRICE_OPEN);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   aticket=oldticket;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   lastticket=aticket;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //we've got the last order ticket, which will be used in the next calculations<br>   return(oldopenprice);<br>  }<br>//+------------------------------------------------------------------+<br>//| Find the value of the current step&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   |<br>//+------------------------------------------------------------------+<br>double FindStepSize(ENUM_POSITION_TYPE order_type)<br>  {<br>   int stage;<br>   double stepsize;<br>   if(order_type==POSITION_TYPE_BUY) //find the step of buy orders<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(ManualstepBuy>0) //in case of manual step - each next step will be equal this value<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stepsize=ManualstepBuy*Point();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return(stepsize);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  stage=CountBuyOrders();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   //current crank is amount of open buy orders<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(stage==1) //if oder in the basket is first<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(Stepfromvolatility==true) //if step identifying is calculated by volatility<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stepsize=Volatility(PeriodVolatility_1)*K_Stepvol;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(stepsize);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//if there is no volatility flag, step is equal to first step<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stepsize=FirstStep*Point();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(stepsize);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(stage>1 && stage<Maxcountstepsbuy)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stepsize=FindLastStep(POSITION_TYPE_BUY);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(Dynamicstep==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(stage>=Stepincreasestep)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   stepsize=stepsize*K_Stepincrease;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   return(stepsize);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return(stepsize);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(stage>=Maxcountstepsbuy)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(Showinfopanel==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allowbuy="Reached maximum crank!";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buystepvalue=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nextpricebuy=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nextlotbuy=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(AlertMaxStepsBuy==false)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Alert("Reached maximum crank in the buy basket!!");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Print("Reached maximum crank in the buy basket!!");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AlertMaxStepsBuy=true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   if(order_type==POSITION_TYPE_SELL) //find the step of sell orders<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(ManualstepSell>0) //in case of manual step - each next step will be equal this value<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stepsize=ManualstepSell*Point();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return(stepsize);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  stage=CountSellOrders();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   //current crank is amount of open buy orders<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(stage==1) //if oder in the basket is first<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(Stepfromvolatility==true) //if step identifying is calculated by volatility<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stepsize=Volatility(PeriodVolatility_1)*K_Stepvol;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(stepsize);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //if there is no volatility flag, step is equal to first step<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stepsize=FirstStep*Point();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(stepsize);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(stage>1 && stage<Maxcountstepsbuy)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stepsize=FindLastStep(POSITION_TYPE_SELL);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(Dynamicstep==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(stage>=Stepincreasestep)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   stepsize=stepsize*K_Stepincrease;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   return(stepsize);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return(stepsize);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(stage>=Maxcountstepsell)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(Showinfopanel==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allowsell="Reached maximum crank!";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sellstepvalue=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nextpricesell=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nextlotsell=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(AlertMaxStepsSell==false)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Alert("Reached maximum crank in the sell basket!!");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Print("Reached maximum crank in the sell basket!!");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AlertMaxStepsSell=true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>   return(100000);<br>  }<br>//+--------------------------------------------------------------------------+<br>//| Function of volatility calculation depending of day bars amount&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  |<br>//+--------------------------------------------------------------------------+<br>double Volatility(int period)<br>  {<br>   double Differ[];<br>   ArrayResize(Differ,period+1,1);<br>   double diff1,<br>   diff=0;<br>   int i,<br>   count=0;<br>   for(i=1; i<=period; i++) //fill the array<br>&nbsp;&nbsp;&nbsp;&nbsp;  Differ[i]=iHigh(Symbol(),PERIOD_D1,i)-iLow(Symbol(),PERIOD_D1,i);&nbsp;&nbsp;&nbsp;&nbsp; //Calculate the value of day candles<br><br>   for(i=1; i<=period; i++)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  diff+=Differ[i];<br>&nbsp;&nbsp;&nbsp;&nbsp;  count++;<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   diff1=diff/count;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//volatility without current candle<br><br>   return(diff1);<br>  }<br>//+------------------------------------------------------------------+<br>//+------------------------------------------------------------------+<br>//  Several functions below are for info-panel<br>//+------------------------------------------------------------------+<br>//+------------------------------------------------------------------+<br>void UpdateInfoWindow(int Ticker, int Neutralize)<br>  {<br>   //depositpercent = RiskDeposit*100/AccountBalance();<br>   //depositloadpersent=FindCurrentLoad();<br>   firstorderlot=Findfirstordervolume();<br>   if(Allowbuylevel==false)<br>   {<br>&nbsp;&nbsp;&nbsp;&nbsp;  allowbuy="Buy orders are forbidden!";<br>&nbsp;&nbsp;&nbsp;&nbsp;  buystepvalue=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;  nextpricebuy=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;  nextlotbuy=0;<br>   }<br>   if(Allowselllevel==false)<br>   {<br>&nbsp;&nbsp;&nbsp;&nbsp;  allowsell="Sell orders are forbidden!";&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;  sellstepvalue=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;  nextpricesell=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;  nextlotsell=0; <br>   }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//update all parameters of info-panel<br>   if(Ticker==1)<br>&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetTextMQL4("Info_3","Power:  |",10,"Calibri",Textcolor);<br>   if(Ticker==2)<br>&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetTextMQL4("Info_3","Power:  ||",10,"Calibri",Textcolor);<br>   if(Ticker==3)<br>&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetTextMQL4("Info_3","Power:  |||",10,"Calibri",Textcolor);<br>   if(Ticker==4)<br>&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetTextMQL4("Info_3","Power:  ||||",10,"Calibri",Textcolor);<br>   if(Ticker==5)<br>&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetTextMQL4("Info_3","Power:  |||||",10,"Calibri",Textcolor);<br>   if(Ticker==6)<br>&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetTextMQL4("Info_3","Power:  ||||||",10,"Calibri",Textcolor);<br>   if(Ticker==7)<br>&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetTextMQL4("Info_3","Power:  |||||||",10,"Calibri",Textcolor);<br>   if(Ticker==8)<br>&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetTextMQL4("Info_3","Power:  ||||||||",10,"Calibri",Textcolor);<br>   if(Ticker==9)<br>&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetTextMQL4("Info_3","Power:  |||||||||",10,"Calibri",Textcolor);<br>   if(Ticker==10)<br>&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetTextMQL4("Info_3","Power:  ||||||||||",10,"Calibri",Textcolor);<br>   if(Neutralize==0)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetTextMQL4("Info_4","Neutralizer BUY:  OFF"+DoubleToString(depositpercent,1)+"%",10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetTextMQL4("Info_5","Neutralizer SELL:  OFF"+DoubleToString(depositloadpersent,1)+"%",10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   if(Neutralize>0)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetTextMQL4("Info_4","Neutralizer BUY:  ON"+DoubleToString(depositpercent,1)+"%",10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetTextMQL4("Info_5","Neutralizer SELL:  OFF"+DoubleToString(depositloadpersent,1)+"%",10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   if(Neutralize<0)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetTextMQL4("Info_4","Neutralizer BUY:  OFF"+DoubleToString(depositpercent,1)+"%",10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp; ObjectSetTextMQL4("Info_5","Neutralizer SELL:  ON"+DoubleToString(depositloadpersent,1)+"%",10,"Calibri",Textcolor);<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   <br>   ObjectSetTextMQL4("Info_6","First orders volume:  "+DoubleToString(firstorderlot,2),10,"Calibri",Textcolor);<br>   <br>   ObjectSetTextMQL4("Info_9",allowbuy,10,"Calibri",Textcolor);<br>   ObjectSetTextMQL4("Info_10","Current crank: "+DoubleToString(currentstepbuy,0),10,"Calibri",Textcolor);<br>   ObjectSetTextMQL4("Info_11","Total volume, lots: "+DoubleToString(sumlotbuy,2),10,"Calibri",Textcolor);<br>   ObjectSetTextMQL4("Info_13","Total profit of opened: "+DoubleToString(buybasketprofit,1),10,"Calibri",Textcolor);<br>   ObjectSetTextMQL4("Info_14","Current grid step: "+DoubleToString(buystepvalue,1)+"p.",10,"Calibri",Textcolor);<br>   ObjectSetTextMQL4("Info_15","Next order open price: "+DoubleToString(nextpricebuy,Digits()),10,"Calibri",Textcolor);<br>   ObjectSetTextMQL4("Info_16","Next order volume: "+DoubleToString(nextlotbuy,2),10,"Calibri",Textcolor);<br>   <br>   ObjectSetTextMQL4("Info_19",allowsell,10,"Calibri",Textcolor);<br>   ObjectSetTextMQL4("Info_20","Current crank: "+DoubleToString(currentstepsell,0),10,"Calibri",Textcolor);<br>   ObjectSetTextMQL4("Info_21","Total volume, lots: "+DoubleToString(sumlotsell,2),10,"Calibri",Textcolor);<br>   ObjectSetTextMQL4("Info_23","Total profit of opened: "+DoubleToString(sellbasketprofit,1),10,"Calibri",Textcolor);<br>   ObjectSetTextMQL4("Info_24","Current grid step: "+DoubleToString(sellstepvalue,1)+"p.",10,"Calibri",Textcolor);<br>   ObjectSetTextMQL4("Info_25","Next order open price: "+DoubleToString(nextpricesell,Digits()),10,"Calibri",Textcolor);<br>   ObjectSetTextMQL4("Info_26","Next order volume: "+DoubleToString(nextlotsell,2),10,"Calibri",Textcolor);<br>  }<br>//+--------------------------------------------------------------------------+<br>//| Define start status&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  |<br>//+--------------------------------------------------------------------------+<br>void UpdateBasketStatus()<br>  {<br>   if(Allowbuy==false)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  switch(Stopmode_2)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case a: allowbuy = "Buy orders are forbidden!"; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; buystepvalue=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nextpricebuy=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nextlotbuy=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case s: allowbuy = "New baskets are forbidden!"; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case n: allowbuy = "New crank is forbidden!"; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; buystepvalue=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nextpricebuy=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nextlotbuy=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  if (Flagbuyinfo==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; allowbuy = "Volatility level is exceeded!";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; buystepvalue=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nextpricebuy=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nextlotbuy=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   else allowbuy="Buy orders are allowed!";<br>   if(Allowsell==false)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  switch(Stopmode_2)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case a: allowsell = "Sell orders are forbidden!"; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sellstepvalue=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nextpricesell=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nextlotsell=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case s: allowsell = "New baskets are forbidden!"; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case n: allowsell = "New crank is forbidden!"; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sellstepvalue=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nextpricesell=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nextlotsell=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  if (Flagsellinfo==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; allowsell = "Volatility level is exceeded!";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sellstepvalue=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nextpricesell=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nextlotsell=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   else allowsell="Sell orders are allowed!";<br>   if(AllowafterlevelBuy==false)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  switch(Stopmode_3)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case s: allowbuy = "New baskets are forbidden!"; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case n: allowbuy = "New crank is forbidden!"; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; buystepvalue=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nextpricebuy=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nextlotbuy=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   if(AllowafterlevelSell==false)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  switch(Stopmode_3)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case s: allowsell = "New baskets are forbidden!"; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case n: allowsell = "New crank is forbidden!"; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sellstepvalue=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nextpricesell=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nextlotsell=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   if (CountBuyOrders()==0)<br>   {<br>&nbsp;&nbsp;&nbsp;&nbsp;  buystepvalue=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;  nextpricebuy=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;  nextlotbuy=0;<br>   }<br>   if (CountSellOrders()==0)<br>   {<br>&nbsp;&nbsp;&nbsp;&nbsp;  sellstepvalue=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;  nextpricesell=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;  nextlotsell=0;<br>   }<br>  }<br>//+--------------------------------------------------------------------------+<br>//| Calculation of the first basket order&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<br>//+--------------------------------------------------------------------------+<br>double Findfirstordervolume()<br>{<br><br>int LotsDigit=0;<br>double firstlot=0, MinLots=0, MaxLots=0, AcFrMar=0, Step=0, One_Lot=0;<br><br>MinLots=SymbolInfoDouble(_Symbol,SYMBOL_VOLUME_MIN);<br>MaxLots=SymbolInfoDouble(_Symbol,SYMBOL_VOLUME_MAX);<br><br>if(Money_Management==false)<br>   {<br>   firstlot=Lot_Size;<br>   }<br><br>if(Money_Management==true)<br>   {<br>   <br>   //bool success = OrderCalcMargin(order_type, _Symbol, 1, SymbolInfoDouble(_Symbol, SYMBOL_BID), One_Lot);<br>   One_Lot=SymbolInfoDouble(_Symbol, SYMBOL_MARGIN_INITIAL); //was MODE_MARGINREQUIRED. SYMBOL_MARGIN_REQUIRED doesn't work for forex, need ordermargincalc<br>   <br>   Step=SymbolInfoDouble(_Symbol,SYMBOL_VOLUME_STEP);  <br>   <br>   AcFrMar=NormalizeDouble(AccountInfoDouble(ACCOUNT_MARGIN_FREE),2);<br>   <br>   firstlot=MathFloor(AcFrMar*Margin_Percent/100/One_Lot/Step)*Step;<br>   <br>   }<br>   <br>if(firstlot>MaxLots)<br>  firstlot=MaxLots;<br>if(firstlot<MinLots)<br>  firstlot=MinLots;<br>  <br>return(firstlot);<br><br>}<br><br>//+------------------------------------------------------------------+<br>//| Error handler for opening orders&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br>//+------------------------------------------------------------------+<br>int OrderSendx(string symbolx, ENUM_ORDER_TYPE cmdx, double volumex, double pricex, int slippagex, double stoplossx, double takeprofitx, <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   string commentx, int magicx, datetime expirationx, color arrow_colorx)<br>  {<br>&nbsp;&nbsp;&nbsp;&nbsp; MqlTick last_tick;<br>&nbsp;&nbsp;&nbsp;&nbsp; SymbolInfoTick(_Symbol,last_tick);<br>&nbsp;&nbsp;&nbsp;&nbsp; double Bid=last_tick.bid;<br>&nbsp;&nbsp;&nbsp;&nbsp; double Ask=last_tick.ask;<br>&nbsp;&nbsp;&nbsp;&nbsp; err = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp; bool exit_loop = false; <br>&nbsp;&nbsp;&nbsp;&nbsp; int ticketx = -1;<br>&nbsp;&nbsp;&nbsp;&nbsp; int retry = 10;<br>&nbsp;&nbsp;&nbsp;&nbsp; int cnt   = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp; if(CheckVolumeValue(volumex)==true && CheckMoneyForTrade(symbolx, volumex, cmdx)==true)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp; while (!exit_loop)<br>&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ticketx = OrderSendxCode (symbolx, cmdx, volumex, pricex, slippagex, stoplossx, takeprofitx, commentx, magicx, expirationx, arrow_colorx);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch(err)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_PLACED:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_DONE:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit_loop = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(ticketx);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_LOCKED:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_REJECT:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_CONNECTION:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_CANCEL:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_INVALID_PRICE:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_INVALID_ORDER:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_NO_MONEY:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_TIMEOUT:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_PRICE_OFF: //was ERR_OFF_QUOTES<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_SERVER_DISABLES_AT:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_CLIENT_DISABLES_AT:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_TOO_MANY_REQUESTS: //was TRADE_CONTEXT_BUSY<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cnt++;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_PRICE_CHANGED:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_REQUOTE:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//removed refreshrates<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cnt++;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   default:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit_loop = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;&nbsp;&nbsp;&nbsp;&nbsp;  <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (cnt>retry)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   exit_loop = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Print("SyTurn Opening error after ", cnt, " attempts");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (err != TRADE_RETCODE_DONE && err != TRADE_RETCODE_PLACED)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Print("SyTurn Error of opening - ", ErrorDescription(err));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!exit_loop)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sleep(3000);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//removed refresh rates<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (cmdx==ORDER_TYPE_SELL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   pricex=Bid;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (cmdx==ORDER_TYPE_BUY)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   pricex=Ask;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp; return(ticketx);<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp;&nbsp; return(0);<br>  }<br><br>//+------------------------------------------------------------------+<br>//| Error handler for modifications of orders&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<br>//+------------------------------------------------------------------+<br>bool OrderModifyx(int ticketx, double pricex, double stoplossx, double takeprofitx, datetime expirationx, color arrow_colorx)<br>  {<br>&nbsp;&nbsp;&nbsp;&nbsp; err = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp; bool exit_loop = false; <br>&nbsp;&nbsp;&nbsp;&nbsp; bool answer = false;<br>&nbsp;&nbsp;&nbsp;&nbsp; int retry = 10;<br>&nbsp;&nbsp;&nbsp;&nbsp; int cnt   = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp; while (!exit_loop)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(PositionSelectByTicket(ticketx)){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;double sl = PositionGetDouble(POSITION_SL);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;answer = Trader.PositionModify(ticketx, sl, takeprofitx);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err = Trader.ResultRetcode();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch(err)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_PLACED:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_DONE:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit_loop = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(answer);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_LOCKED:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_REJECT:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_CONNECTION:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_CANCEL:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_INVALID_PRICE:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_INVALID_ORDER:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_NO_MONEY:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_TIMEOUT:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_PRICE_OFF: //was ERR_OFF_QUOTES<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_SERVER_DISABLES_AT:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_CLIENT_DISABLES_AT:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_TOO_MANY_REQUESTS: //was TRADE_CONTEXT_BUSY<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cnt++;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   default:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit_loop = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;&nbsp;&nbsp;&nbsp;&nbsp;  <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (cnt>retry)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   exit_loop = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Print("SyTurn Modification error after ", cnt, " attempts");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (err != TRADE_RETCODE_DONE && err != TRADE_RETCODE_PLACED)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Print("SyTurn Error of modification - ", ErrorDescription(err));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!exit_loop)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sleep(5000);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//removed refreshrates<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp; return(answer);<br>  }<br><br>//+------------------------------------------------------------------+<br>//| Error handler for closing of orders&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  |<br>//+------------------------------------------------------------------+<br>bool OrderClosex(ENUM_ORDER_TYPE cmdx, int ticketx, double lotsx, double pricex, int slippagex, color arrow_colorx)<br>  {<br>&nbsp;&nbsp;&nbsp;&nbsp; MqlTick last_tick;<br>&nbsp;&nbsp;&nbsp;&nbsp; SymbolInfoTick(_Symbol,last_tick);<br>&nbsp;&nbsp;&nbsp;&nbsp; double Bid=last_tick.bid;<br>&nbsp;&nbsp;&nbsp;&nbsp; double Ask=last_tick.ask;  <br>&nbsp;&nbsp;&nbsp;&nbsp; err = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp; bool exit_loop = false; <br>&nbsp;&nbsp;&nbsp;&nbsp; bool answer = false;<br>&nbsp;&nbsp;&nbsp;&nbsp; int retry = 10;<br>&nbsp;&nbsp;&nbsp;&nbsp; int cnt   = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp; while (!exit_loop)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp; if(PositionSelectByTicket(ticketx)){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;answer = Trader.PositionClose(ticketx);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err = Trader.ResultRetcode();}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch(err)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_PLACED:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_DONE:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit_loop = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(answer);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_LOCKED:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_REJECT:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_CONNECTION:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_CANCEL:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_INVALID_PRICE:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_INVALID_ORDER:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_NO_MONEY:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_TIMEOUT:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_PRICE_OFF: //was ERR_OFF_QUOTES<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_SERVER_DISABLES_AT:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_CLIENT_DISABLES_AT:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_TOO_MANY_REQUESTS: //was TRADE_CONTEXT_BUSY<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cnt++;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_PRICE_CHANGED:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   case TRADE_RETCODE_REQUOTE:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//removed refreshrates<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cnt++;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   default:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit_loop = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;&nbsp;&nbsp;&nbsp;&nbsp;  <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (cnt>retry)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   exit_loop = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Print("SyTurn Closing error after ", cnt, " attempts");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (err != TRADE_RETCODE_DONE && err != TRADE_RETCODE_PLACED)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Print("SyTurn Error of closing - ", ErrorDescription(err));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!exit_loop)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sleep(5000);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//removed refreshrates<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (cmdx==ORDER_TYPE_BUY)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   pricex=Ask;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (cmdx==ORDER_TYPE_SELL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   pricex=Bid;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp; return(answer);<br>  }<br><br>//+------------------------------------------------------------------+<br>//| Errors description function&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  |<br>//+------------------------------------------------------------------+<br>string ErrorDescription(int error) //these errors may not apply in MQL5<br>  {<br>   string error_string;<br>   switch(error)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 0:   error_string="no error";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 1:   error_string="no error, trade conditions not changed";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 2:   error_string="common error";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 3:   error_string="invalid trade parameters";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4:   error_string="trade server is busy";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 5:   error_string="old version of the client terminal";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 6:   error_string="no connection with trade server";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 7:   error_string="not enough rights";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 8:   error_string="too frequent requests";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 9:   error_string="malfunctional trade operation (never returned error)";&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 64:  error_string="account disabled";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 65:  error_string="invalid account";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 128: error_string="trade timeout";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 129: error_string="invalid price";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 130: error_string="invalid stops";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 131: error_string="invalid trade volume";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 132: error_string="market is closed";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 133: error_string="trade is disabled";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 134: error_string="not enough money";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 135: error_string="price changed";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 136: error_string="off quotes";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 137: error_string="broker is busy (never returned error)";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 138: error_string="requote";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 139: error_string="order is locked";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 140: error_string="long positions only allowed";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 141: error_string="too many requests";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 145: error_string="modification denied because order is too close to market";   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 146: error_string="trade context is busy";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 147: error_string="expirations are denied by broker";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 148: error_string="amount of open and pending orders has reached the limit";&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 149: error_string="hedging is prohibited";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 150: error_string="prohibited by FIFO rules";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4000: error_string="no error (never generated code)";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4001: error_string="wrong function pointer";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4002: error_string="array index is out of range";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4003: error_string="no memory for function call stack";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4004: error_string="recursive stack overflow";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4005: error_string="not enough stack for parameter";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4006: error_string="no memory for parameter string";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4007: error_string="no memory for temp string";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4008: error_string="non-initialized string";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4009: error_string="non-initialized string in array";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4010: error_string="no memory for array\' string";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4011: error_string="too long string";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4012: error_string="remainder from zero divide";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4013: error_string="zero divide";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4014: error_string="unknown command";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4015: error_string="wrong jump (never generated error)";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4016: error_string="non-initialized array";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4017: error_string="dll calls are not allowed";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4018: error_string="cannot load library";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4019: error_string="cannot call function";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4020: error_string="expert function calls are not allowed";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4021: error_string="not enough memory for temp string returned from function";  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4022: error_string="system is busy (never generated error)";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4023: error_string="dll-function call critical error";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4024: error_string="internal error";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4025: error_string="out of memory";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4026: error_string="invalid pointer";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4027: error_string="too many formatters in the format function";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4028: error_string="parameters count is more than formatters count";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4029: error_string="invalid array";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4030: error_string="no reply from chart";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4050: error_string="invalid function parameters count";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4051: error_string="invalid function parameter value";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4052: error_string="string function internal error";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4053: error_string="some array error";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4054: error_string="incorrect series array usage";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4055: error_string="custom indicator error";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4056: error_string="arrays are incompatible";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4057: error_string="global variables processing error";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4058: error_string="global variable not found";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4059: error_string="function is not allowed in testing mode";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4060: error_string="function is not confirmed";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4061: error_string="send mail error";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4062: error_string="string parameter expected";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4063: error_string="integer parameter expected";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4064: error_string="double parameter expected";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4065: error_string="array as parameter expected";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4066: error_string="requested history data is in update state";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4067: error_string="internal trade error";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4068: error_string="resource not found";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4069: error_string="resource not supported";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4070: error_string="duplicate resource";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4071: error_string="cannot initialize custom indicator";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4072: error_string="cannot load custom indicator";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4073: error_string="no history data";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4074: error_string="not enough memory for history data";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4075: error_string="not enough memory for indicator";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4099: error_string="end of file";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4100: error_string="some file error";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4101: error_string="wrong file name";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4102: error_string="too many opened files";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4103: error_string="cannot open file";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4104: error_string="incompatible access to a file";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4105: error_string="no order selected";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4106: error_string="unknown symbol";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4107: error_string="invalid price parameter for trade function";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4108: error_string="invalid ticket";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4109: error_string="trade is not allowed in the expert properties";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4110: error_string="longs are not allowed in the expert properties";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4111: error_string="shorts are not allowed in the expert properties";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4200: error_string="object already exists";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4201: error_string="unknown object property";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4202: error_string="object does not exist";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4203: error_string="unknown object type";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4204: error_string="no object name";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4205: error_string="object coordinates error";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4206: error_string="no specified subwindow";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4207: error_string="graphical object error";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4210: error_string="unknown chart property";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4211: error_string="chart not found";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4212: error_string="chart subwindow not found";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4213: error_string="chart indicator not found";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4220: error_string="symbol select error";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4250: error_string="notification error";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4251: error_string="notification parameter error";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4252: error_string="notifications disabled";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4253: error_string="notification send too frequent";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4260: error_string="ftp server is not specified";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4261: error_string="ftp login is not specified";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4262: error_string="ftp connect failed";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4263: error_string="ftp connect closed";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4264: error_string="ftp change path error";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4265: error_string="ftp file error";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  case 4266: error_string="ftp error";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  default:   error_string="unknown error";<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   return(error_string);<br>}<br><br>//+------------------------------------------------------------------+<br>//+------------------------------------------------------------------+<br><br>double APR_Walked(string mode, int j) {<br><br>//Vektors_TF is replaced by PERIOD_M5 throughout<br>double DayHigh;<br>double DayLow;<br>double DayRange;<br>double DayRangeLine[];<br>double Retracement[];<br>double Poin;<br><br>int NewSize = Stability_Period*3;<br>  //----  Checking the change of the zero bar<br>  if(ArraySize(DayRangeLine) < NewSize)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;  //---- Set the direct indexing direction in the array <br>&nbsp;&nbsp;&nbsp;&nbsp;  ArraySetAsSeries(DayRangeLine, false);<br>&nbsp;&nbsp;&nbsp;&nbsp;  //---- Change the size of the emulated indicator buffers <br>&nbsp;&nbsp;&nbsp;&nbsp;  ArrayResize(DayRangeLine, NewSize);  <br>&nbsp;&nbsp;&nbsp;&nbsp;  //---- Set the reverse indexing direction in the array <br>&nbsp;&nbsp;&nbsp;&nbsp;  ArraySetAsSeries(DayRangeLine, true); <br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>  if(ArraySize(Retracement) < NewSize)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;  //---- Set the direct indexing direction in the array <br>&nbsp;&nbsp;&nbsp;&nbsp;  ArraySetAsSeries(Retracement, false);<br>&nbsp;&nbsp;&nbsp;&nbsp;  //---- Change the size of the emulated indicator buffers <br>&nbsp;&nbsp;&nbsp;&nbsp;  ArrayResize(Retracement, NewSize);  <br>&nbsp;&nbsp;&nbsp;&nbsp;  //---- Set the reverse indexing direction in the array <br>&nbsp;&nbsp;&nbsp;&nbsp;  ArraySetAsSeries(Retracement, true); <br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>Poin = Point();<br>&nbsp;&nbsp;&nbsp;&nbsp;//Checking for unconventional Point digits number<br>   if ((Point() == 0.00001) || (Point() == 0.001)  || (Point() == 0.01)  || (Point() == 0.1))<br>   {<br>&nbsp;&nbsp;&nbsp;&nbsp;  Poin *= 10;<br>   }<br><br>string Date_Raw;<br>datetime Date_Filtered;<br>int Bar_Shift_From_DayStart, Bars_To_Screen, Bar_Shift_High, Bar_Shift_Low;<br> <br>for(int i=0; i<=MathFloor(Stability_Period*1.5); i++)<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Date_Raw=TimeToString(iTime(_Symbol, PERIOD_M5, i),TIME_DATE);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Date_Filtered=StringToTime(Date_Raw);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Bar_Shift_From_DayStart=iBarShift(_Symbol, PERIOD_M5, Date_Filtered);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Bars_To_Screen=Bar_Shift_From_DayStart-i;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(Bars_To_Screen==0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   DayRangeLine[i]=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   continue;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Bar_Shift_High = iHighest(_Symbol, PERIOD_M5, MODE_HIGH, Bars_To_Screen, i);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Bar_Shift_Low = iLowest(_Symbol, PERIOD_M5, MODE_LOW, Bars_To_Screen, i);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DayHigh = iHigh(_Symbol, PERIOD_M5, Bar_Shift_High);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DayLow = iLow(_Symbol, PERIOD_M5, Bar_Shift_Low);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DayRange = (DayHigh-DayLow)/Poin;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DayRangeLine[i] = DayRange;<br>&nbsp;&nbsp;&nbsp;&nbsp;  <br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br><br>if(mode=="Line")<br>  {<br>  return(DayRangeLine[j]);<br>  }<br>  <br>return(0);  <br><br>}<br><br>//---<br><br>int CloseAll()<br>{ <br>   bool rv = NO_ERROR; //defined as 1 at the very start. So true? "at least one failed" is also true (defined as 2, any value not zero (false) is true), but is not equivalent to no error<br>   int numOfOrders = OrdersTotal();<br>   int FirstOrderType = 0;<br>   int index = 0;<br>   bool Selection;<br>   <br>   for (index = 0; index < PositionsTotal(); index++)   <br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;   Selection=PositionGetTicket(index);<br>&nbsp;&nbsp;&nbsp;&nbsp;   if (PositionGetString(POSITION_SYMBOL) == Symbol()) <br>&nbsp;&nbsp;&nbsp;&nbsp;   {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FirstOrderType = PositionGetInteger(POSITION_TYPE);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;   }<br>&nbsp;&nbsp;&nbsp;&nbsp; }   <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>   for(index = numOfOrders - 1; index >= 0; index--)<br>   {<br>&nbsp;&nbsp;&nbsp;&nbsp;  Selection=PositionGetTicket(index);<br>&nbsp;&nbsp;&nbsp;&nbsp;  <br>&nbsp;&nbsp;&nbsp;&nbsp;  if (PositionGetString(POSITION_SYMBOL) == Symbol())<br>&nbsp;&nbsp;&nbsp;&nbsp;  switch (PositionGetInteger(POSITION_TYPE))<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case POSITION_TYPE_BUY: <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!Trader.PositionClose(index)) //orderclose is mql4 function that returns true if successful. so this means "if not true"?<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   rv = AT_LEAST_ONE_FAILED;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case POSITION_TYPE_SELL:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!Trader.PositionClose(index))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   rv = AT_LEAST_ONE_FAILED;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //case OP_BUYLIMIT: position_ty  These don't have equivalents in MQL5<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //case OP_SELLLIMIT:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //case OP_BUYSTOP: <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //case OP_SELLSTOP:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //   if (!OrderDelete(OrderTicket()))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //&nbsp;&nbsp;&nbsp;&nbsp;  rv = AT_LEAST_ONE_FAILED;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //   break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br>   }<br><br>   return(rv);<br>}<br><br>//--<br><br>bool CheckVolumeValue(double volume)<br>  {<br>//--- minimal allowed volume for trade operations<br>   double min_volume=SymbolInfoDouble(Symbol(),SYMBOL_VOLUME_MIN);<br>   if(volume<min_volume)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  //description=StringFormat("Volume is less than the minimal allowed SYMBOL_VOLUME_MIN=%.2f",min_volume);<br>&nbsp;&nbsp;&nbsp;&nbsp;  return(false);<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>//--- maximal allowed volume of trade operations<br>   double max_volume=SymbolInfoDouble(Symbol(),SYMBOL_VOLUME_MAX);<br>   if(volume>max_volume)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  //description=StringFormat("Volume is greater than the maximal allowed SYMBOL_VOLUME_MAX=%.2f",max_volume);<br>&nbsp;&nbsp;&nbsp;&nbsp;  return(false);<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>//--- get minimal step of volume changing<br>   double volume_step=SymbolInfoDouble(Symbol(),SYMBOL_VOLUME_STEP);<br><br>   int ratio=(int)MathRound(volume/volume_step);<br>   if(MathAbs(ratio*volume_step-volume)>0.0000001)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  //description=StringFormat("Volume is not a multiple of the minimal step SYMBOL_VOLUME_STEP=%.2f, the closest correct volume is %.2f",<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   //volume_step,ratio*volume_step);<br>&nbsp;&nbsp;&nbsp;&nbsp;  return(false);<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   //description="Correct volume value";<br>   return(true);<br>  }<br><br>//--<br><br>bool CheckMoneyForTrade(string symb,double lots,int type)<br>  {<br>   double free_margin= AccountInfoDouble(ACCOUNT_FREEMARGIN);<br>   //-- if there is not enough money<br>   if(free_margin<0)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  string oper=(type==POSITION_TYPE_BUY)? "Buy":"Sell";<br>&nbsp;&nbsp;&nbsp;&nbsp;  //fPrint("Not enough money for ", oper," ",lots, " ", symb, " Error code=",GetLastError());<br>&nbsp;&nbsp;&nbsp;&nbsp;  return(false);<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   //--- checking successful<br>   return(true);<br>  }<br><br>//--<br><br>bool CheckStopLoss_Takeprofit(ENUM_ORDER_TYPE type, double SL, double TP)<br>  {<br>&nbsp;&nbsp;&nbsp;&nbsp; MqlTick last_tick;<br>&nbsp;&nbsp;&nbsp;&nbsp; SymbolInfoTick(_Symbol,last_tick);<br>&nbsp;&nbsp;&nbsp;&nbsp; double Bid=last_tick.bid;<br>&nbsp;&nbsp;&nbsp;&nbsp; double Ask=last_tick.ask;<br>//--- get the SYMBOL_TRADE_STOPS_LEVEL level<br>   int stops_level=(int)SymbolInfoInteger(_Symbol,SYMBOL_TRADE_STOPS_LEVEL);<br>//---<br>   bool SL_check=false,TP_check=false;<br>//--- check only two order types<br>   switch(type)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  //--- Buy operation<br>&nbsp;&nbsp;&nbsp;&nbsp;  case  ORDER_TYPE_BUY:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //--- check the StopLoss<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SL_check=(Bid-SL>stops_level*_Point);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(SL==0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   SL_check=true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //--- check the TakeProfit<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TP_check=(TP-Bid>stops_level*_Point);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(TP==0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   TP_check=true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //--- return the result of checking<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return(SL_check&&TP_check);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  //--- Sell operation<br>&nbsp;&nbsp;&nbsp;&nbsp;  case  ORDER_TYPE_SELL:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //--- check the StopLoss<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SL_check=(SL-Ask>stops_level*_Point);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(SL==0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   SL_check=true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //--- check the TakeProfit<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TP_check=(Ask-TP>stops_level*_Point);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(TP==0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   TP_check=true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //--- return the result of checking<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return(TP_check&&SL_check);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>//--- a slightly different function is required for pending orders<br>   return false;<br>  }<br><br>//--<br><br>void ResetOrderArray(double &Buy_Loss_Array[][],double &Buy_Profit_Array[][],double &Sell_Loss_Array[][],double &Sell_Profit_Array[][], double &Aux_Array[][]) {<br>   <br> for(int h=0; h<2; h++)  <br>   for(int k=0; k<MaxPos*4; k++)<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;  Buy_Loss_Array[k][h]=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;  Buy_Profit_Array[k][h]=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;  Sell_Loss_Array[k][h]=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;  Sell_Profit_Array[k][h]=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;  Aux_Array[k][h]=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br><br>}<br>//--<br><br>void ResetOrderArrayTarget(double &Aux_Array_Target[][]) {<br>   <br> for(int h=0; h<2; h++)  <br>   for(int k=0; k<MaxPos*4; k++)<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;  Aux_Array_Target[k][h]=0;<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br><br>}<br><br>//--<br><br>datetime OrderLaunch(string Action, double &Aux_Array_Target[][], int a, double Vol, int Order_Count)<br>{<br>//-- Point Value<br>int k=0;<br>if(Digits()==5 || Digits()==3)<br>  k=10;<br>else<br>  k=1;<br>//-- Opening Process<br>int i=0, j=0;<br>bool Order_Modificator=false;<br>int Order_Number=0;<br>datetime Time_Cached=0;<br><br>  if(Action=="SELL")<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;for(j=a; j>=0; j--)<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(Aux_Array_Target[j][1]==0 && Aux_Array_Target[j][0]!=0) //if the x dimension of the index has a ticket no, and the y dimension has a value of 0<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OrderLaunch("SELL", Aux_Array_Target, a, PositionGetDouble(POSITION_VOLUME), CountBuyOrders()); a is the index of the worst buy position, or that closest in number<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(PositionSelectByTicket(Aux_Array_Target[j][0])==true) //removed doubletostring and stringtointeger functions<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(CheckVolumeValue(PositionGetDouble(POSITION_VOLUME)*Order_Count)==true && CheckMoneyForTrade(_Symbol, PositionGetDouble(POSITION_VOLUME)*Order_Count, POSITION_TYPE_SELL)==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for(i=0; i<Retry; i++)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //refreshrates&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Order_Number = OrderLaunchCode(Order_Count, ORDER_TYPE_SELL);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Print("Order Number: ", Order_Number);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  if(Order_Number>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Aux_Array_Target[j][1]=1;  <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  } }<br><br>  if(Action=="BUY")<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;for(j=a; j>=0; j--)<br>&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(Aux_Array_Target[j][1]==0 && Aux_Array_Target[j][0]!=0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(PositionSelectByTicket(Aux_Array_Target[j][0])==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(CheckVolumeValue(PositionGetDouble(POSITION_VOLUME)*Order_Count)==true && CheckMoneyForTrade(_Symbol, PositionGetDouble(POSITION_VOLUME)*Order_Count, POSITION_TYPE_BUY)==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for(i=0; i<Retry; i++)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  //refreshrates<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Order_Number=-1;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Order_Number = OrderLaunchCode(Order_Count, ORDER_TYPE_BUY);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  if(Order_Number>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Aux_Array_Target[j][1]=1;  <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>  Time_Cached=iTime(_Symbol, _Period, 0);<br>  return(Time_Cached);<br>  <br>}<br><br>//--<br><br>bool CloseSelected(string TickeT, int _Retry) //unsurprisingly, closes the selected order, regardless of its position type<br>  {<br>  <br>  bool Closing_Order=false;<br>  <br>  //removed refreshrates. mql4 function. returns boolean true if successful. refreshes data in pre-defined variables and series arrays<br>  <br>  if(PositionSelectByTicket(StringToInteger(TickeT))==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>//&nbsp;&nbsp;&nbsp;&nbsp;if(PositionGetInteger(POSITION_MAGIC)==Magic_Buy)<br>//&nbsp;&nbsp;&nbsp;&nbsp;  if(PositionGetInteger(POSITION_TYPE)==POSITION_TYPE_BUY)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for(int i=0; i<_Retry; i++)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Closing_Order=Trader.PositionClose(PositionGetTicket(i));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  if(Closing_Order==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;//if(PositionGetInteger(POSITION_MAGIC)==Magic_Sell) //all this extra stuff might not be necessary when using the PositionClose function<br>&nbsp;&nbsp;&nbsp;&nbsp;  //if(PositionGetInteger(POSITION_TYPE)==POSITION_TYPE_SELL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//for(int i=0; i<_Retry; i++)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//  Closing_Order=Trader.PositionClose(PositionGetTicket(i));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//  if(Closing_Order==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//  }<br>&nbsp;&nbsp;&nbsp;&nbsp;//if(PositionGetInteger(POSITION_MAGIC)==Magic_Aux)<br>&nbsp;&nbsp;&nbsp;&nbsp;//  {<br>&nbsp;&nbsp;&nbsp;&nbsp;  //if(PositionGetInteger(POSITION_TYPE)==POSITION_TYPE_BUY)<br>&nbsp;&nbsp;&nbsp;&nbsp;  //  for(int i=0; i<_Retry; i++)<br>&nbsp;&nbsp;&nbsp;&nbsp;  //&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;  //&nbsp;&nbsp;&nbsp;&nbsp;Closing_Order=Trader.PositionClose(PositionGetTicket(i));<br>&nbsp;&nbsp;&nbsp;&nbsp;  //&nbsp;&nbsp;&nbsp;&nbsp;if(Closing_Order==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;  //&nbsp;&nbsp;&nbsp;&nbsp;  break;<br>&nbsp;&nbsp;&nbsp;&nbsp;  //&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  //if(PositionGetInteger(POSITION_TYPE)==POSITION_TYPE_SELL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//for(int i=0; i<_Retry; i++)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//  {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//  Closing_Order=Trader.PositionClose(PositionGetTicket(i));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//  if(Closing_Order==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//  }<br>&nbsp;&nbsp;&nbsp;&nbsp;  //}<br>&nbsp;&nbsp;&nbsp;&nbsp;  <br>&nbsp;&nbsp;&nbsp;&nbsp;return(true);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>  else<br>&nbsp;&nbsp;&nbsp;&nbsp;return(false);<br>  <br>  }<br>  <br>//--<br><br>bool ObjectSetTextMQL4(string name,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   string text,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   int font_size,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   string font="",<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   color text_color=CLR_NONE)<br>  {<br>   int tmpObjType=(int)ObjectGetInteger(0,name,OBJPROP_TYPE);<br>   if(tmpObjType!=OBJ_LABEL && tmpObjType!=OBJ_TEXT) return(false);<br>   if(StringLen(text)>0 && font_size>0)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;  if(ObjectSetString(0,name,OBJPROP_TEXT,text)==true<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; && ObjectSetInteger(0,name,OBJPROP_FONTSIZE,font_size)==true)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if((StringLen(font)>0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&& ObjectSetString(0,name,OBJPROP_FONT,font)==false)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(false);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(ObjectSetInteger(0,name,OBJPROP_COLOR,text_color)==false) //removed if text_color>-1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(false);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return(true);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  return(false);<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>   return(false);<br>  }<br>  <br>//--<br><br>double BBands(int buffer){<br><br>   double BBArray[];<br>   ArraySetAsSeries(BBArray, true);<br>   int BBandVal = iBands(NULL, 0, Tick_Memory, 0, Deviation, SYMBOL_BID);<br>   CopyBuffer(BBandVal, buffer, 0, 2, BBArray);<br>   return BBArray[0];}<br>   <br>//--<br><br>double ADXcheck(ENUM_TIMEFRAMES tf, int period, int shift){<br>&nbsp;&nbsp;&nbsp;&nbsp;  double ADXArray[];<br>&nbsp;&nbsp;&nbsp;&nbsp;  ArraySetAsSeries(ADXArray, true);<br>&nbsp;&nbsp;&nbsp;&nbsp;  double ADXVal = iADX(_Symbol, tf , period);<br>&nbsp;&nbsp;&nbsp;&nbsp;  CopyBuffer(ADXVal, 0, shift, 2, ADXArray);<br>&nbsp;&nbsp;&nbsp;&nbsp;  return ADXArray[0];}<br>&nbsp;&nbsp;&nbsp;&nbsp;  <br>//--<br><br>double MAcheck(int period, int multi, ENUM_MA_METHOD method, ENUM_APPLIED_PRICE price, int shift){<br>&nbsp;&nbsp;&nbsp;&nbsp;  double MAArray[];<br>&nbsp;&nbsp;&nbsp;&nbsp;  ArraySetAsSeries(MAArray, true);<br>&nbsp;&nbsp;&nbsp;&nbsp;  double MAVal = iMA(_Symbol,Period(), period*multi, 0, method, price);<br>&nbsp;&nbsp;&nbsp;&nbsp;  CopyBuffer(MAVal, 0, 0, 2, MAArray);<br>&nbsp;&nbsp;&nbsp;&nbsp;  return MAArray[shift];}<br>&nbsp;&nbsp;&nbsp;&nbsp;  <br>//--&nbsp;&nbsp;&nbsp;&nbsp;  <br>&nbsp;&nbsp;&nbsp;&nbsp;  <br>double SARcheck(int shift){<br>   double SARArray[];<br>   ArraySetAsSeries(SARArray, true);<br>   double SARVal = iSAR(Symbol(),Period(),0.02,0.2);<br>   CopyBuffer(SARVal, 0, 0, 5, SARArray);<br>   return SARArray[shift];}<br>   <br>//--<br><br>double MACDcheck(ENUM_APPLIED_PRICE price, int buffer){<br>   double MACDArray[];<br>   ArraySetAsSeries(MACDArray, true);   <br>   double MACDVal = iMACD(Symbol(),Period(),12,26,9,price);<br>   CopyBuffer(MACDVal, buffer, 0, 2, MACDArray);<br>   return MACDArray[0];}<br>   <br>//--<br><br>double CCIcheck(int period, ENUM_APPLIED_PRICE price, int shift){<br>   double CCIArray[];<br>   ArraySetAsSeries(CCIArray, true);<br>   double CCIVal = iCCI(Symbol(), 0, period, price);<br>   CopyBuffer(CCIVal, 0, 0, 3, CCIArray);<br>   return CCIArray[shift];<br>}<br>   <br>//--<br><br>long PositionType = PositionGetInteger(POSITION_TYPE);<br><br>//--<br><br>int AuxTradeOrderSend(int magicno, double volume, int deviateamt, ENUM_ORDER_TYPE order, int arrcolor){<br>&nbsp;&nbsp;&nbsp;&nbsp;  <br>&nbsp;&nbsp;&nbsp;&nbsp;  MqlTick last_tick;<br>&nbsp;&nbsp;&nbsp;&nbsp;  SymbolInfoTick(_Symbol,last_tick);<br>&nbsp;&nbsp;&nbsp;&nbsp;  double Bid=last_tick.bid;<br>&nbsp;&nbsp;&nbsp;&nbsp;  double Ask=last_tick.ask;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   <br>&nbsp;&nbsp;&nbsp;&nbsp;  double sl = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp;  //if(order == order_type_BUY){<br>&nbsp;&nbsp;&nbsp;&nbsp;  //   sl = Ask-slfixed;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  //if(order == order_type_SELL){<br>&nbsp;&nbsp;&nbsp;&nbsp;  //   sl = Bid+slfixed;}&nbsp;&nbsp;&nbsp;&nbsp;  <br>&nbsp;&nbsp;&nbsp;&nbsp;  Trader.SetExpertMagicNumber(magicno);<br>&nbsp;&nbsp;&nbsp;&nbsp;  Trader.SetDeviationInPoints(deviateamt);<br>&nbsp;&nbsp;&nbsp;&nbsp;  bool success = Trader.PositionOpen(_Symbol, order, volume, 0, sl, 0);<br>&nbsp;&nbsp;&nbsp;&nbsp;  int ticketno = PositionGetTicket(PositionsTotal()-1);<br>&nbsp;&nbsp;&nbsp;&nbsp;  return(ticketno);}<br>//--<br><br>int OrderSendxCode (string symbolx, ENUM_ORDER_TYPE order, double volumex, double pricex, int slippagex, double stoplossx, double takeprofitx, <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   string commentx, int magicx, datetime expirationx, color arrow_colorx){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MqlTick last_tick;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SymbolInfoTick(_Symbol,last_tick);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;double Bid=last_tick.bid;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;double Ask=last_tick.ask;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;double sl = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//if(order == order_type_BUY){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//   sl = Ask-slfixed;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//if(order == order_type_SELL){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//   sl = Bid+slfixed;}  <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Trader.SetExpertMagicNumber(magicx);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Trader.SetDeviationInPoints(slippagex);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MqlTradeResult result={};<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bool success = Trader.PositionOpen(symbolx, order, volumex, pricex, sl, takeprofitx, commentx);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err = result.retcode;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int ticketno = PositionGetTicket(PositionsTotal()-1);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(ticketno);}<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>//--<br><br>int OrderLaunchCode(int Order_Count, ENUM_ORDER_TYPE order)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;double price = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MqlTick last_tick;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SymbolInfoTick(_Symbol,last_tick);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;double Bid=last_tick.bid;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;double Ask=last_tick.ask;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;double sl = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp;  //if(order == order_type_BUY){<br>&nbsp;&nbsp;&nbsp;&nbsp;  //   sl = Ask-slfixed;}<br>&nbsp;&nbsp;&nbsp;&nbsp;  //if(order == order_type_SELL){<br>&nbsp;&nbsp;&nbsp;&nbsp;  //   sl = Bid+slfixed;} <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Trader.SetExpertMagicNumber(Magic_Aux);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(order == ORDER_TYPE_BUY){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;price = Ask;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(order == ORDER_TYPE_SELL){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;price = Bid;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bool success = Trader.PositionOpen(_Symbol, order, PositionGetDouble(POSITION_VOLUME)*Order_Count, price, sl, 0);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int ticketno = PositionGetTicket(PositionsTotal()-1);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return(ticketno);}<br>//--<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>int DayOfWeekMQL4()<br>  {<br>   MqlDateTime tm;<br>   TimeCurrent(tm);<br>   return(tm.day_of_week);<br>  }<br>  <br>//--<br><br>int HourMQL4()<br>  {<br>   MqlDateTime tm;<br>   TimeCurrent(tm);<br>   return(tm.hour);<br>  }
	</p>
	
	<script>
	/* function Toggle() {
		var x = document.getElementById("pycode");
		if (x.style.display === "none") 
			{x.style.display = "block";} 
		else {x.style.display = "none"; }} 
		*/
		
	function Copy() {
		const copyText = document.getElementById("pycode").innerText; 
		navigator.clipboard.writeText(copyText);}
	</script>
</div>
</main>
</body>
</html>

